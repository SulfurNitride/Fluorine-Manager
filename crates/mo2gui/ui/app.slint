import { Button, ComboBox, LineEdit, ListView, CheckBox, TabWidget,
         VerticalBox, HorizontalBox, GridBox, Palette, ScrollView } from "std-widgets.slint";

// ===== Shared Data Structs =====

export struct ModEntry {
    name: string,
    display-name: string,
    enabled: bool,
    priority: int,
    mod-type: string,
    version: string,
    is-separator: bool,
    is-overwrite: bool,
    is-collapsed: bool,
    separator-has-children: bool,
    hidden-by-collapse: bool,
    has-root: bool,
    flags-text: string,
    category-name: string,
    content-text: string,
    conflict-text: string,
    has-winning: bool,
    has-losing: bool,
    winning-opponents: string,
    winning-opponent-keys: string,
    losing-opponents: string,
    losing-opponent-keys: string,
    highlight-winning: bool,
    highlight-losing: bool,
    nexus-id: int,
    notes: string,
}

export struct InstanceEntry {
    name: string,
    game-name: string,
    path: string,
    display-path: string,
    is-portable: bool,
}

export struct PluginEntry {
    filename: string,
    enabled: bool,
    priority: int,
    plugin-type: string,   // "ESM", "ESP", "ESL"
    origin-mod: string,
    is-master: bool,
    is-light: bool,
    is-locked: bool,
}

export struct FilterItem {
    name: string,
    depth: int,
    checked: bool,
    is-expanded: bool,
    has-children: bool,
    count: int,
}

export struct ExecutableEntry {
    title: string,
    binary: string,
    arguments: string,
    working-directory: string,
    show-in-toolbar: bool,
    hide: bool,
}

export struct ArchiveEntry {
    filename: string,
    origin-mod: string,
    mod-enabled: bool,
}

export struct DataEntry {
    name: string,
    virtual-path: string,
    origin: string,
    is-directory: bool,
    depth: int,
    size: string,
    is-expanded: bool,
    has-children: bool,
}

export struct DownloadEntry {
    filename: string,
    size-text: string,
    nexus-id: int,
    version: string,
    installed: bool,
}

export struct SaveEntry {
    filename: string,
    character: string,
    size-text: string,
    date-text: string,
}

export struct DetectedGame {
    name: string,
    app-id: string,
    install-path: string,
    prefix-path: string,
    launcher: string,
}

export struct ProtonEntry {
    name: string,
    path: string,
}

export struct InstallTreeEntry {
    name: string,
    path: string,
    is-directory: bool,
    depth: int,
    checked: bool,
    is-expanded: bool,
    has-children: bool,
    is-data-root: bool,
}

// ===== Main Window =====

export component MainWindow inherits Window {
    title: root.game-name != "" ? root.game-name + " – MO2 Linux" : "MO2 Linux";
    preferred-width: 1200px;
    preferred-height: 700px;
    min-width: 1200px;
    min-height: 700px;

    // --- Page switching: 0=instance manager, 1=main app, 2=creation wizard ---
    in-out property <int> current-page: 0;

    // --- Instance Manager properties ---
    in-out property <[InstanceEntry]> instance-list;
    in-out property <int> selected-instance: -1;

    // --- Creation Wizard properties ---
    in-out property <int> wizard-step: 0;
    in-out property <bool> wizard-is-portable: false;
    in-out property <string> wizard-game-name;
    in-out property <string> wizard-game-path;
    in-out property <string> wizard-instance-name;
    in-out property <string> wizard-location;
    in-out property <[string]> known-games;

    // --- Main App properties ---
    in-out property <string> game-name;
    in-out property <string> game-path;
    in-out property <string> active-profile;
    in-out property <string> instance-path;
    in-out property <bool> fuse-mounted: false;
    in-out property <bool> locked: false;
    in-out property <string> locked-tool-name;
    in-out property <int> mod-count: 0;
    in-out property <int> enabled-mod-count: 0;
    in-out property <[string]> profile-list;
    in-out property <[ModEntry]> mod-list;
    in-out property <string> selected-mod-name;
    in-out property <string> selected-mod-winning: "";
    in-out property <string> selected-mod-losing: "";
    in-out property <int> sort-column: 1;
    in-out property <bool> sort-ascending: true;
    in-out property <string> filter-text;
    in-out property <float> split-ratio: 0.56;  // left panel ratio (0.0–1.0)
    in-out property <float> split-drag-start: 0.6;

    // --- Drag-drop reorder state ---
    in-out property <bool> drag-active: false;
    in-out property <int> drag-from-index: -1;
    in-out property <int> drag-to-index: -1;
    in-out property <length> drag-start-y: 0px;
    in-out property <int> selected-mod-index: -1;

    // --- Mod list column widths (resizable) ---
    in-out property <length> mod-col-priority-width: 65px;
    in-out property <length> mod-col-type-width: 80px;
    in-out property <length> mod-col-version-width: 80px;
    in-out property <length> mod-col-flags-width: 55px;
    in-out property <length> mod-col-category-width: 100px;
    in-out property <length> mod-col-content-width: 70px;
    in-out property <length> mod-col-conflicts-width: 70px;
    in-out property <length> mod-col-nexus-id-width: 65px;
    in-out property <length> mod-col-notes-width: 120px;

    // --- Mod list column visibility (right-click to toggle) ---
    in-out property <bool> show-col-flags: false;
    in-out property <bool> show-col-category: false;
    in-out property <bool> show-col-content: false;
    in-out property <bool> show-col-conflicts: false;
    in-out property <bool> show-col-priority: true;
    in-out property <bool> show-col-type: false;
    in-out property <bool> show-col-version: false;
    in-out property <bool> show-col-nexus-id: false;
    in-out property <bool> show-col-notes: false;

    // --- Column chooser popup ---
    in-out property <bool> show-column-chooser: false;
    in-out property <length> column-chooser-x: 40px;
    in-out property <length> column-chooser-y: 80px;

    // --- Mod context menu ---
    in-out property <bool> show-mod-context-menu: false;
    in-out property <length> mod-context-menu-x: 0px;
    in-out property <length> mod-context-menu-y: 0px;
    in-out property <bool> context-mod-is-separator: false;
    in-out property <bool> context-mod-enabled: false;

    // --- Plugin context menu ---
    in-out property <bool> show-plugin-context-menu: false;
    in-out property <length> plugin-context-menu-x: 0px;
    in-out property <length> plugin-context-menu-y: 0px;
    in-out property <string> context-plugin-name;
    in-out property <bool> context-plugin-enabled: false;

    // --- Plugin drag-drop reorder state ---
    in-out property <bool> plg-drag-active: false;
    in-out property <int> plg-drag-from-index: -1;
    in-out property <int> plg-drag-to-index: -1;
    in-out property <length> plg-drag-start-y: 0px;

    // --- Filter/Categories panel ---
    in-out property <bool> show-filter-panel: false;
    in-out property <[FilterItem]> filter-items;
    in-out property <bool> filter-and-mode: false;  // false=OR, true=AND

    // --- Menu bar ---
    in-out property <int> open-menu: -1;  // -1=none, 0=File, 1=Tools, 2=View, 3=Help

    // --- Plugin list column widths (resizable) ---
    in-out property <length> plg-col-priority-width: 55px;

    // --- Toolbar executable properties ---
    in-out property <[string]> toolbar-tools;
    in-out property <string> selected-toolbar-tool;
    in-out property <bool> has-toolbar-tools: false;

    // --- Tool Editor properties ---
    in-out property <[ExecutableEntry]> tool-list;
    in-out property <int> selected-tool: -1;
    in-out property <string> tool-edit-title;
    in-out property <string> tool-edit-binary;
    in-out property <string> tool-edit-arguments;
    in-out property <string> tool-edit-workdir;
    in-out property <bool> tool-edit-toolbar: false;
    in-out property <bool> tool-edit-hide: false;
    in-out property <bool> show-tool-editor: false;

    // --- Settings properties ---
    in-out property <bool> show-settings: false;
    in-out property <int> settings-tab: 0;
    in-out property <string> settings-base-dir;
    in-out property <string> settings-downloads-dir;
    in-out property <string> settings-mods-dir;
    in-out property <string> settings-profiles-dir;
    in-out property <string> settings-overwrite-dir;
    in-out property <bool> settings-local-inis: true;
    in-out property <bool> settings-local-saves: false;
    in-out property <bool> settings-auto-archive-invalidation: true;
    in-out property <string> instance-display-path;

    // --- Plugin list properties ---
    in-out property <[PluginEntry]> plugin-list;
    in-out property <int> plugin-count: 0;
    in-out property <int> enabled-plugin-count: 0;
    in-out property <int> plugin-sort-column: 1;
    in-out property <bool> plugin-sort-ascending: true;
    in-out property <string> plugin-filter-text;

    // --- Instance Manager callbacks ---
    callback open-selected-instance();
    callback browse-portable();
    callback remove-selected-instance();
    callback create-new-instance();

    // --- Creation Wizard callbacks ---
    callback wizard-finish(/* is-portable */ bool, /* game */ string, /* name-or-path */ string);
    callback wizard-cancel();
    callback wizard-browse-location();
    callback wizard-browse-game-path();

    // --- Main App callbacks ---
    callback set-profile(/* name */ string);
    callback select-mod(/* mod name */ string);
    callback toggle-mod(/* mod name */ string);
    callback toggle-separator-collapse(/* separator name */ string);
    callback force-unlock();
    callback refresh();
    callback fuse-mount();
    callback fuse-unmount();
    callback switch-instance();
    callback sort-mods(/* column: 0=name 1=pri 2=type 3=ver */ int);
    callback reorder-mod(/* from-index */ int, /* to-index */ int);
    callback filter-mods(/* filter-text */ string);
    callback import-instance();

    // --- Menu bar callbacks ---
    callback menu-action(/* action */ string);

    // --- Filter panel callbacks ---
    callback toggle-filter(/* index */ int);
    callback toggle-filter-expand(/* index */ int);
    callback clear-filters();

    // --- Plugin list callbacks ---
    callback toggle-plugin(/* plugin filename */ string);
    callback filter-plugins(/* filter-text */ string);
    callback sort-plugins(/* column */ int);

    // --- Context menu callbacks ---
    callback mod-context-action(/* action */ string);
    callback plugin-context-action(/* action */ string);

    // --- Plugin reorder callback ---
    callback reorder-plugin(/* from-index */ int, /* to-index */ int);

    // --- Tool Editor callbacks ---
    callback add-tool();
    callback remove-tool(/* index */ int);
    callback save-tools();
    callback browse-tool-binary();
    callback browse-tool-workdir();
    callback run-tool(/* index */ int);
    callback select-tool(/* index */ int);
    callback play();
    callback open-tool-editor();
    callback close-tool-editor();

    // --- Archives tab properties ---
    in-out property <[ArchiveEntry]> archive-list;
    in-out property <int> archive-count: 0;
    in-out property <string> archive-filter-text;

    // --- Data tab properties ---
    in-out property <[DataEntry]> data-list;
    in-out property <int> data-file-count: 0;
    in-out property <string> data-filter-text;

    // --- Downloads tab properties ---
    in-out property <[DownloadEntry]> download-list;
    in-out property <int> download-count: 0;

    // --- Saves tab properties ---
    in-out property <[SaveEntry]> save-list;
    in-out property <int> save-count: 0;

    // --- Archives tab callbacks ---
    callback filter-archives(/* filter-text */ string);

    // --- Data tab callbacks ---
    callback toggle-data-expand(/* index */ int);
    callback filter-data(/* filter-text */ string);

    // --- Wine/Proton properties ---
    in-out property <[DetectedGame]> detected-games;
    in-out property <[ProtonEntry]> available-protons;
    in-out property <[string]> proton-names;
    in-out property <string> selected-proton-name;
    in-out property <string> selected-proton-path;
    in-out property <string> wine-prefix-path;
    in-out property <string> steam-app-id;
    in-out property <bool> prefix-exists: false;
    in-out property <bool> prefix-busy: false;
    in-out property <float> prefix-progress: 0;
    in-out property <string> prefix-status-text: "No prefix configured";

    // --- Settings callbacks ---
    callback open-settings();
    callback close-settings();
    callback browse-game-path();
    callback browse-settings-base-dir();
    callback browse-settings-downloads();
    callback browse-settings-mods();
    callback browse-settings-profiles();
    callback browse-settings-overwrite();
    callback set-profile-local-inis(/* enabled */ bool);
    callback set-profile-local-saves(/* enabled */ bool);
    callback set-profile-auto-archive-invalidation(/* enabled */ bool);

    // --- Wine/Proton callbacks ---
    callback detect-games();
    callback select-detected-game(/* index */ int);
    callback set-proton-version(/* proton name */ string);
    callback create-prefix();
    callback delete-prefix();
    callback browse-wine-prefix();

    // --- Rename dialog ---
    in-out property <bool> show-rename-dialog: false;
    in-out property <string> rename-dialog-value;
    in-out property <string> rename-dialog-title: "Rename";
    in-out property <string> rename-target-name;  // internal name of mod/separator being renamed
    in-out property <bool> rename-target-is-separator: false;
    callback confirm-rename(/* new-name */ string);

    // --- Install dialog ---
    in-out property <bool> show-install-dialog: false;
    in-out property <string> install-mod-name;
    in-out property <[InstallTreeEntry]> install-tree;
    in-out property <bool> install-data-valid: false;
    in-out property <string> install-data-path;
    in-out property <string> install-staging-path;  // temp staging dir (for Rust to reference)
    in-out property <bool> show-install-tree-menu: false;
    in-out property <length> install-tree-menu-x: 0px;
    in-out property <length> install-tree-menu-y: 0px;
    in-out property <string> install-tree-context-path;
    in-out property <bool> install-tree-context-is-dir: false;
    callback install-confirm(/* mod-name */ string);
    callback install-cancel();
    callback install-set-data-dir(/* path */ string);
    callback install-toggle-expand(/* path */ string);
    callback install-create-folder(/* parent-path */ string);

    // =====================================================
    // PAGE 0: Instance Manager
    // =====================================================
    if current-page == 0 : VerticalBox {
        // Header
        HorizontalBox {
            height: 48px;
            padding: 8px;
            spacing: 8px;

            Text {
                text: "MO2 Linux — Instance Manager";
                font-size: 18px;
                font-weight: 700;
                vertical-alignment: center;
                color: Palette.foreground;
            }
            Rectangle { horizontal-stretch: 1; }
        }

        Rectangle {
            height: 1px;
            background: Palette.border;
        }

        // Instance list
        ListView {
            vertical-stretch: 1;

            for inst[index] in root.instance-list : Rectangle {
                height: 52px;
                background: index == root.selected-instance ? Palette.accent-background
                    : mod(index, 2) == 0 ? Palette.alternate-background
                    : Palette.background;

                TouchArea {
                    clicked => {
                        root.selected-instance = index;
                    }
                    double-clicked => {
                        root.selected-instance = index;
                        root.open-selected-instance();
                    }
                }

                HorizontalBox {
                    padding: 8px;
                    spacing: 12px;

                    VerticalBox {
                        horizontal-stretch: 1;
                        spacing: 2px;
                        Text {
                            text: inst.name;
                            font-weight: 600;
                            font-size: 14px;
                            color: Palette.foreground;
                            overflow: elide;
                        }
                        Text {
                            text: inst.display-path;
                            font-size: 11px;
                            color: Palette.foreground.transparentize(40%);
                            overflow: elide;
                            horizontal-alignment: right;
                        }
                    }
                    Text {
                        text: inst.game-name;
                        width: 180px;
                        vertical-alignment: center;
                        color: Palette.foreground.transparentize(20%);
                        overflow: elide;
                    }
                    Rectangle {
                        width: 70px;
                        height: 22px;
                        border-radius: 4px;
                        background: inst.is-portable ? #2196f3 : #4caf50;
                        VerticalLayout {
                            alignment: center;
                            HorizontalLayout {
                                alignment: center;
                                Text {
                                    text: inst.is-portable ? "Portable" : "Global";
                                    font-size: 11px;
                                    color: #ffffff;
                                }
                            }
                        }
                    }
                }
            }
        }

        Rectangle {
            height: 1px;
            background: Palette.border;
        }

        // Action buttons
        HorizontalBox {
            height: 44px;
            padding: 6px;
            spacing: 8px;

            Button {
                text: "Open";
                enabled: root.selected-instance >= 0;
                clicked => { root.open-selected-instance(); }
            }
            Button {
                text: "Create New";
                clicked => { root.create-new-instance(); }
            }
            Button {
                text: "Browse...";
                clicked => { root.browse-portable(); }
            }
            Button {
                text: "Import MO2...";
                clicked => { root.import-instance(); }
            }

            Rectangle { horizontal-stretch: 1; }

            Button {
                text: "Remove";
                enabled: root.selected-instance >= 0;
                clicked => { root.remove-selected-instance(); }
            }
        }
    }

    // =====================================================
    // PAGE 2: Creation Wizard
    // =====================================================
    if current-page == 2 : VerticalBox {
        padding: 24px;
        spacing: 16px;

        Text {
            text: "Create New Instance";
            font-size: 20px;
            font-weight: 700;
            color: Palette.foreground;
        }

        Rectangle {
            height: 1px;
            background: Palette.border;
        }

        // Step 0: Type selection
        if root.wizard-step == 0 : VerticalBox {
            spacing: 12px;

            Text {
                text: "Choose instance type:";
                font-size: 14px;
                color: Palette.foreground;
            }

            HorizontalBox {
                spacing: 16px;

                // Global option
                Rectangle {
                    horizontal-stretch: 1;
                    height: 100px;
                    border-radius: 8px;
                    border-width: 2px;
                    border-color: !root.wizard-is-portable ? Palette.accent-background : Palette.border;
                    background: !root.wizard-is-portable ? Palette.accent-background.transparentize(90%) : Palette.background;

                    TouchArea {
                        clicked => { root.wizard-is-portable = false; }
                    }

                    VerticalBox {
                        padding: 12px;
                        spacing: 4px;
                        Text {
                            text: "Global Instance";
                            font-weight: 700;
                            font-size: 14px;
                            color: Palette.foreground;
                        }
                        Text {
                            text: "Stored in ~/.local/share/MO2Linux/";
                            font-size: 11px;
                            color: Palette.foreground.transparentize(40%);
                        }
                    }
                }

                // Portable option
                Rectangle {
                    horizontal-stretch: 1;
                    height: 100px;
                    border-radius: 8px;
                    border-width: 2px;
                    border-color: root.wizard-is-portable ? Palette.accent-background : Palette.border;
                    background: root.wizard-is-portable ? Palette.accent-background.transparentize(90%) : Palette.background;

                    TouchArea {
                        clicked => { root.wizard-is-portable = true; }
                    }

                    VerticalBox {
                        padding: 12px;
                        spacing: 4px;
                        Text {
                            text: "Portable Instance";
                            font-weight: 700;
                            font-size: 14px;
                            color: Palette.foreground;
                        }
                        Text {
                            text: "Choose any folder. Creates portable.txt marker.";
                            font-size: 11px;
                            color: Palette.foreground.transparentize(40%);
                        }
                    }
                }
            }
        }

        // Step 1: Game selection
        if root.wizard-step == 1 : VerticalBox {
            spacing: 12px;

            HorizontalBox {
                spacing: 8px;
                Text {
                    text: "Select game:";
                    font-size: 14px;
                    color: Palette.foreground;
                    vertical-alignment: center;
                    horizontal-stretch: 1;
                }
                Button {
                    text: "Detect Games";
                    clicked => { root.detect-games(); }
                }
            }

            // Detected games list (shown when games detected)
            if root.detected-games.length > 0 : Rectangle {
                height: 140px;
                border-radius: 4px;
                border-width: 1px;
                border-color: Palette.border;
                background: Palette.alternate-background;
                clip: true;

                ScrollView {
                    VerticalBox {
                        spacing: 0px;
                        padding: 0px;

                        for game[idx] in root.detected-games : Rectangle {
                            height: 28px;
                            background: touch-game.has-hover ? Palette.accent-background.transparentize(70%) : transparent;

                            touch-game := TouchArea {
                                clicked => { root.select-detected-game(idx); }
                            }

                            HorizontalBox {
                                padding-left: 8px;
                                padding-right: 8px;
                                spacing: 12px;
                                Text {
                                    text: game.name;
                                    color: Palette.foreground;
                                    vertical-alignment: center;
                                    horizontal-stretch: 1;
                                    overflow: elide;
                                }
                                Text {
                                    text: game.launcher;
                                    color: Palette.foreground.transparentize(40%);
                                    vertical-alignment: center;
                                    font-size: 11px;
                                }
                            }
                        }
                    }
                }
            }

            wizard-game-combo := ComboBox {
                model: root.known-games;
                current-value: root.wizard-game-name;
                selected(value) => { root.wizard-game-name = value; }
            }

            Text {
                text: "Or type a custom game name:";
                font-size: 12px;
                color: Palette.foreground.transparentize(40%);
            }

            wizard-game-input := LineEdit {
                height: 32px;
                text: root.wizard-game-name;
                edited(value) => { root.wizard-game-name = value; }
                placeholder-text: "Game name...";
            }
        }

        // Step 2: Game directory
        if root.wizard-step == 2 : VerticalBox {
            spacing: 12px;

            Text {
                text: "Set game directory:";
                font-size: 14px;
                color: Palette.foreground;
            }

            Text {
                text: "Select the folder where the game executable lives.";
                font-size: 12px;
                color: Palette.foreground.transparentize(40%);
            }

            HorizontalBox {
                spacing: 8px;

                Text {
                    text: root.wizard-game-path != "" ? root.wizard-game-path : "No folder selected";
                    horizontal-stretch: 1;
                    vertical-alignment: center;
                    color: root.wizard-game-path != "" ? Palette.foreground : Palette.foreground.transparentize(50%);
                    overflow: elide;
                }
                Button {
                    text: "Browse...";
                    clicked => { root.wizard-browse-game-path(); }
                }
            }
        }

        // Step 3: Instance name or location
        if root.wizard-step == 3 : VerticalBox {
            spacing: 12px;

            if !root.wizard-is-portable : VerticalBox {
                spacing: 8px;
                Text {
                    text: "Instance name:";
                    font-size: 14px;
                    color: Palette.foreground;
                }
                wizard-name-input := LineEdit {
                    height: 32px;
                    text: root.wizard-instance-name;
                    edited(value) => { root.wizard-instance-name = value; }
                    placeholder-text: "My Skyrim Setup";
                }
            }

            if root.wizard-is-portable : VerticalBox {
                spacing: 8px;
                Text {
                    text: "Instance location:";
                    font-size: 14px;
                    color: Palette.foreground;
                }
                HorizontalBox {
                    spacing: 8px;

                    Text {
                        text: root.wizard-location != "" ? root.wizard-location : "No folder selected";
                        horizontal-stretch: 1;
                        vertical-alignment: center;
                        color: root.wizard-location != "" ? Palette.foreground : Palette.foreground.transparentize(50%);
                        overflow: elide;
                    }
                    Button {
                        text: "Browse...";
                        clicked => { root.wizard-browse-location(); }
                    }
                }
            }
        }

        // Step 4: Summary
        if root.wizard-step == 4 : VerticalBox {
            spacing: 8px;

            Text {
                text: "Summary";
                font-size: 16px;
                font-weight: 600;
                color: Palette.foreground;
            }

            GridBox {
                spacing: 8px;

                Row {
                    Text { text: "Type:"; font-weight: 600; color: Palette.foreground; }
                    Text {
                        text: root.wizard-is-portable ? "Portable" : "Global";
                        color: Palette.foreground;
                    }
                }
                Row {
                    Text { text: "Game:"; font-weight: 600; color: Palette.foreground; }
                    Text { text: root.wizard-game-name; color: Palette.foreground; }
                }
                Row {
                    Text { text: "Game Path:"; font-weight: 600; color: Palette.foreground; }
                    Text {
                        text: root.wizard-game-path != "" ? root.wizard-game-path : "(not set)";
                        color: Palette.foreground;
                        overflow: elide;
                    }
                }
                Row {
                    Text {
                        text: root.wizard-is-portable ? "Location:" : "Name:";
                        font-weight: 600;
                        color: Palette.foreground;
                    }
                    Text {
                        text: root.wizard-is-portable ? root.wizard-location : root.wizard-instance-name;
                        color: Palette.foreground;
                        overflow: elide;
                    }
                }
            }
        }

        // Spacer
        Rectangle { vertical-stretch: 1; }

        Rectangle {
            height: 1px;
            background: Palette.border;
        }

        // Navigation buttons
        HorizontalBox {
            height: 44px;
            spacing: 8px;

            Button {
                text: "Cancel";
                clicked => { root.wizard-cancel(); }
            }

            Rectangle { horizontal-stretch: 1; }

            if root.wizard-step > 0 : Button {
                text: "Back";
                clicked => { root.wizard-step -= 1; }
            }
            if root.wizard-step < 4 : Button {
                text: "Next";
                clicked => { root.wizard-step += 1; }
            }
            if root.wizard-step == 4 : Button {
                text: "Create";
                clicked => {
                    root.wizard-finish(
                        root.wizard-is-portable,
                        root.wizard-game-name,
                        root.wizard-is-portable ? root.wizard-location : root.wizard-instance-name
                    );
                }
            }
        }
    }

    // =====================================================
    // PAGE 1: Main App
    // =====================================================
    if current-page == 1 : Rectangle {
        VerticalBox {
            // ===== Menu Bar =====
            Rectangle {
                height: 28px;
                background: Palette.alternate-background;

                HorizontalLayout {
                    padding-left: 4px;
                    spacing: 0px;

                    // File menu button
                    Rectangle {
                        width: 50px;
                        background: root.open-menu == 0 ? Palette.accent-background : menu-file-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                        menu-file-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.open-menu = root.open-menu == 0 ? -1 : 0; }
                        }
                        VerticalLayout { alignment: center; HorizontalLayout { alignment: center;
                            Text { text: "File"; font-size: 12px; color: Palette.foreground; }
                        } }
                    }

                    // Tools menu button
                    Rectangle {
                        width: 55px;
                        background: root.open-menu == 1 ? Palette.accent-background : menu-tools-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                        menu-tools-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.open-menu = root.open-menu == 1 ? -1 : 1; }
                        }
                        VerticalLayout { alignment: center; HorizontalLayout { alignment: center;
                            Text { text: "Tools"; font-size: 12px; color: Palette.foreground; }
                        } }
                    }

                    // View menu button
                    Rectangle {
                        width: 50px;
                        background: root.open-menu == 2 ? Palette.accent-background : menu-view-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                        menu-view-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.open-menu = root.open-menu == 2 ? -1 : 2; }
                        }
                        VerticalLayout { alignment: center; HorizontalLayout { alignment: center;
                            Text { text: "View"; font-size: 12px; color: Palette.foreground; }
                        } }
                    }

                    // Help menu button
                    Rectangle {
                        width: 50px;
                        background: root.open-menu == 3 ? Palette.accent-background : menu-help-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                        menu-help-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.open-menu = root.open-menu == 3 ? -1 : 3; }
                        }
                        VerticalLayout { alignment: center; HorizontalLayout { alignment: center;
                            Text { text: "Help"; font-size: 12px; color: Palette.foreground; }
                        } }
                    }

                    Rectangle { horizontal-stretch: 1; }
                }
            }

            Rectangle { height: 1px; background: Palette.border; }

            // ===== Toolbar =====
            HorizontalBox {
                height: 40px;
                padding: 4px;
                spacing: 8px;

                Button {
                    text: "Switch Instance";
                    clicked => { root.switch-instance(); }
                }

                // Separator
                Rectangle {
                    width: 1px;
                    background: Palette.border;
                }

                Text {
                    text: "Profile:";
                    vertical-alignment: center;
                }
                profile-combo := ComboBox {
                    width: 180px;
                    model: root.profile-list;
                    current-value: root.active-profile;
                    selected(value) => { root.set-profile(value); }
                }

                // Separator
                Rectangle {
                    width: 1px;
                    background: Palette.border;
                }

                Button {
                    text: root.show-filter-panel ? "Filters ✓" : "Filters";
                    clicked => { root.show-filter-panel = !root.show-filter-panel; }
                }
                Button {
                    text: "Refresh";
                    clicked => { root.refresh(); }
                }
                Button {
                    text: "Settings";
                    clicked => { root.open-settings(); }
                }

                // Separator
                Rectangle {
                    width: 1px;
                    background: Palette.border;
                }

                // FUSE toggle button
                Rectangle {
                    height: 28px;
                    width: vfs-layout.preferred-width + 16px;
                    border-radius: 4px;
                    background: vfs-touch.has-hover
                        ? (root.fuse-mounted ? #4caf50.transparentize(70%) : Palette.foreground.transparentize(85%))
                        : transparent;
                    vfs-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            if (root.fuse-mounted) {
                                root.fuse-unmount();
                            } else {
                                root.fuse-mount();
                            }
                        }
                    }
                    vfs-layout := HorizontalLayout {
                        padding-left: 4px;
                        padding-right: 4px;
                        spacing: 6px;
                        alignment: center;
                        Rectangle {
                            width: 10px;
                            height: 10px;
                            border-radius: 5px;
                            background: root.fuse-mounted ? #4caf50 : #9e9e9e;
                        }
                        Text {
                            text: root.fuse-mounted ? "VFS Mounted" : "VFS Idle";
                            vertical-alignment: center;
                            font-size: 11px;
                            color: root.fuse-mounted ? #4caf50 : Palette.foreground.transparentize(50%);
                        }
                    }
                }

                // Locked indicator
                if root.locked : Rectangle {
                    height: 28px;
                    width: locked-layout.preferred-width + 16px;
                    border-radius: 4px;
                    background: unlock-touch.has-hover ? #f44336.transparentize(70%) : transparent;
                    unlock-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => { root.force-unlock(); }
                    }
                    locked-layout := HorizontalLayout {
                        padding-left: 4px;
                        padding-right: 4px;
                        spacing: 6px;
                        alignment: center;
                        Rectangle {
                            width: 10px;
                            height: 10px;
                            border-radius: 5px;
                            background: #f44336;
                        }
                        Text {
                            text: "Locked: " + root.locked-tool-name;
                            vertical-alignment: center;
                            font-size: 11px;
                            color: #f44336;
                        }
                    }
                }

                // Spacer
                Rectangle { horizontal-stretch: 1; }

                Text {
                    text: root.enabled-mod-count + " / " + root.mod-count + " mods";
                    vertical-alignment: center;
                    color: Palette.foreground;
                }
            }

            // ===== Main Content =====
            content-area := HorizontalLayout {
                vertical-stretch: 1;

                // --- Filter/Categories Panel (collapsible) ---
                if root.show-filter-panel : VerticalBox {
                    width: 220px;

                    // Header
                    Rectangle {
                        height: 32px;
                        background: Palette.alternate-background;

                        HorizontalBox {
                            padding-left: 8px;
                            padding-right: 4px;

                            Text {
                                text: "Filters";
                                font-weight: 700;
                                font-size: 12px;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                            Rectangle { horizontal-stretch: 1; }
                            // And/Or toggle
                            Rectangle {
                                width: 40px;
                                height: 22px;
                                border-radius: 4px;
                                background: root.filter-and-mode ? #2196f3 : #4caf50;

                                TouchArea {
                                    clicked => { root.filter-and-mode = !root.filter-and-mode; }
                                    mouse-cursor: pointer;
                                }

                                VerticalLayout {
                                    alignment: center;
                                    HorizontalLayout {
                                        alignment: center;
                                        Text {
                                            text: root.filter-and-mode ? "AND" : "OR";
                                            font-size: 10px;
                                            font-weight: 700;
                                            color: #ffffff;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    Rectangle { height: 1px; background: Palette.border; }

                    // Filter tree
                    ListView {
                        vertical-stretch: 1;

                        for item[index] in root.filter-items : Rectangle {
                            height: 26px;
                            background: mod(index, 2) == 0 ? Palette.alternate-background : Palette.background;

                            HorizontalLayout {
                                padding-left: item.depth * 16px + 4px;
                                spacing: 2px;

                                // Expand/collapse arrow
                                if item.has-children : Rectangle {
                                    width: 18px;
                                    height: 18px;

                                    TouchArea {
                                        mouse-cursor: pointer;
                                        clicked => { root.toggle-filter-expand(index); }
                                    }

                                    VerticalLayout {
                                        alignment: center;
                                        HorizontalLayout {
                                            alignment: center;
                                            Text {
                                                text: item.is-expanded ? "▼" : "▶";
                                                font-size: 9px;
                                                color: Palette.foreground.transparentize(30%);
                                            }
                                        }
                                    }
                                }
                                if !item.has-children : Rectangle {
                                    width: 18px;
                                }

                                CheckBox {
                                    width: 22px;
                                    checked: item.checked;
                                    toggled => { root.toggle-filter(index); }
                                }

                                Text {
                                    text: item.name;
                                    horizontal-stretch: 1;
                                    vertical-alignment: center;
                                    overflow: elide;
                                    font-size: 12px;
                                    color: Palette.foreground;
                                }

                                if item.count > 0 : Text {
                                    text: item.count;
                                    vertical-alignment: center;
                                    font-size: 10px;
                                    color: Palette.foreground.transparentize(50%);
                                }
                            }
                        }
                    }

                    Rectangle { height: 1px; background: Palette.border; }

                    // Bottom bar
                    HorizontalBox {
                        height: 28px;
                        padding: 4px;
                        spacing: 4px;

                        Button {
                            text: "Clear";
                            clicked => { root.clear-filters(); }
                        }
                        Rectangle { horizontal-stretch: 1; }
                    }
                }

                // Filter panel divider
                if root.show-filter-panel : Rectangle {
                    width: 1px;
                    background: Palette.border;
                }

                // --- Left: Mod List ---
                Rectangle {
                    width: clamp(
                        root.show-filter-panel
                            ? (content-area.width - 222px) * root.split-ratio
                            : content-area.width * root.split-ratio,
                        500px,
                        root.show-filter-panel
                            ? (content-area.width - 222px) - 430px
                            : content-area.width - 430px
                    );

                    VerticalLayout {
                        spacing: 0px;

                    // Column headers (clickable for sorting, right-click for column chooser, drag-resize dividers)
                    mod-header := Rectangle {
                        height: 32px;
                        background: Palette.alternate-background;

                        HorizontalLayout {
                            padding-left: 32px;
                            padding-right: 8px;

                            // Mod Name column (always visible, fills remaining space)
                            Rectangle {
                                horizontal-stretch: 1;
                                background: mod-col0-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                mod-col0-touch := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.sort-mods(0); }
                                    pointer-event(event) => {
                                        if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                                            root.column-chooser-x = self.absolute-position.x + self.mouse-x;
                                            root.column-chooser-y = self.absolute-position.y + self.mouse-y;
                                            root.show-column-chooser = !root.show-column-chooser;
                                        }
                                    }
                                }
                                HorizontalLayout {
                                    padding-left: 4px;
                                    Text { text: "Mod Name"; font-weight: 700; font-size: 12px; vertical-alignment: center; color: Palette.foreground; }
                                    Text { text: root.sort-column == 0 ? (root.sort-ascending ? " ▲" : " ▼") : ""; font-size: 10px; vertical-alignment: center; color: Palette.foreground.transparentize(30%); }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                            }

                            // === Flags column ===
                            if root.show-col-flags : Rectangle {
                                width: 5px;
                                background: mod-div-flags.has-hover || mod-div-flags.pressed ? Palette.accent-background : transparent;
                                mod-div-flags := TouchArea {
                                    mouse-cursor: col-resize;
                                    moved => { root.mod-col-flags-width = clamp(root.mod-col-flags-width - (self.mouse-x - self.pressed-x), 20px, 300px); }
                                }
                            }
                            if root.show-col-flags : Rectangle {
                                width: root.mod-col-flags-width;
                                clip: true;
                                background: mod-col-flags-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                mod-col-flags-touch := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.sort-mods(4); }
                                    pointer-event(event) => {
                                        if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                                            root.column-chooser-x = self.absolute-position.x + self.mouse-x;
                                            root.column-chooser-y = self.absolute-position.y + self.mouse-y;
                                            root.show-column-chooser = !root.show-column-chooser;
                                        }
                                    }
                                }
                                HorizontalLayout {
                                    padding-left: 4px;
                                    Text { text: "Flags"; font-weight: 700; font-size: 12px; vertical-alignment: center; color: Palette.foreground; }
                                    Text { text: root.sort-column == 4 ? (root.sort-ascending ? " ▲" : " ▼") : ""; font-size: 10px; vertical-alignment: center; color: Palette.foreground.transparentize(30%); }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                            }

                            // === Conflicts column ===
                            if root.show-col-conflicts : Rectangle {
                                width: 5px;
                                background: mod-div-conf.has-hover || mod-div-conf.pressed ? Palette.accent-background : transparent;
                                mod-div-conf := TouchArea {
                                    mouse-cursor: col-resize;
                                    moved => { root.mod-col-conflicts-width = clamp(root.mod-col-conflicts-width - (self.mouse-x - self.pressed-x), 20px, 300px); }
                                }
                            }
                            if root.show-col-conflicts : Rectangle {
                                width: root.mod-col-conflicts-width;
                                clip: true;
                                background: mod-col-conf-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                mod-col-conf-touch := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.sort-mods(7); }
                                    pointer-event(event) => {
                                        if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                                            root.column-chooser-x = self.absolute-position.x + self.mouse-x;
                                            root.column-chooser-y = self.absolute-position.y + self.mouse-y;
                                            root.show-column-chooser = !root.show-column-chooser;
                                        }
                                    }
                                }
                                HorizontalLayout {
                                    padding-left: 4px;
                                    Text { text: "Conflicts"; font-weight: 700; font-size: 12px; vertical-alignment: center; color: Palette.foreground; }
                                    Text { text: root.sort-column == 7 ? (root.sort-ascending ? " ▲" : " ▼") : ""; font-size: 10px; vertical-alignment: center; color: Palette.foreground.transparentize(30%); }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                            }

                            // === Category column ===
                            if root.show-col-category : Rectangle {
                                width: 5px;
                                background: mod-div-cat.has-hover || mod-div-cat.pressed ? Palette.accent-background : transparent;
                                mod-div-cat := TouchArea {
                                    mouse-cursor: col-resize;
                                    moved => { root.mod-col-category-width = clamp(root.mod-col-category-width - (self.mouse-x - self.pressed-x), 20px, 300px); }
                                }
                            }
                            if root.show-col-category : Rectangle {
                                width: root.mod-col-category-width;
                                clip: true;
                                background: mod-col-cat-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                mod-col-cat-touch := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.sort-mods(5); }
                                    pointer-event(event) => {
                                        if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                                            root.column-chooser-x = self.absolute-position.x + self.mouse-x;
                                            root.column-chooser-y = self.absolute-position.y + self.mouse-y;
                                            root.show-column-chooser = !root.show-column-chooser;
                                        }
                                    }
                                }
                                HorizontalLayout {
                                    padding-left: 4px;
                                    Text { text: "Category"; font-weight: 700; font-size: 12px; vertical-alignment: center; color: Palette.foreground; }
                                    Text { text: root.sort-column == 5 ? (root.sort-ascending ? " ▲" : " ▼") : ""; font-size: 10px; vertical-alignment: center; color: Palette.foreground.transparentize(30%); }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                            }

                            // === Content column ===
                            if root.show-col-content : Rectangle {
                                width: 5px;
                                background: mod-div-cont.has-hover || mod-div-cont.pressed ? Palette.accent-background : transparent;
                                mod-div-cont := TouchArea {
                                    mouse-cursor: col-resize;
                                    moved => { root.mod-col-content-width = clamp(root.mod-col-content-width - (self.mouse-x - self.pressed-x), 20px, 300px); }
                                }
                            }
                            if root.show-col-content : Rectangle {
                                width: root.mod-col-content-width;
                                clip: true;
                                background: mod-col-cont-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                mod-col-cont-touch := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.sort-mods(6); }
                                    pointer-event(event) => {
                                        if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                                            root.column-chooser-x = self.absolute-position.x + self.mouse-x;
                                            root.column-chooser-y = self.absolute-position.y + self.mouse-y;
                                            root.show-column-chooser = !root.show-column-chooser;
                                        }
                                    }
                                }
                                HorizontalLayout {
                                    padding-left: 4px;
                                    Text { text: "Content"; font-weight: 700; font-size: 12px; vertical-alignment: center; color: Palette.foreground; }
                                    Text { text: root.sort-column == 6 ? (root.sort-ascending ? " ▲" : " ▼") : ""; font-size: 10px; vertical-alignment: center; color: Palette.foreground.transparentize(30%); }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                            }

                            // === Priority column ===
                            if root.show-col-priority : Rectangle {
                                width: 5px;
                                background: mod-div0.has-hover || mod-div0.pressed ? Palette.accent-background : transparent;
                                mod-div0 := TouchArea {
                                    mouse-cursor: col-resize;
                                    moved => { root.mod-col-priority-width = clamp(root.mod-col-priority-width - (self.mouse-x - self.pressed-x), 20px, 300px); }
                                }
                            }
                            if root.show-col-priority : Rectangle {
                                width: root.mod-col-priority-width;
                                clip: true;
                                background: mod-col1-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                mod-col1-touch := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.sort-mods(1); }
                                    pointer-event(event) => {
                                        if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                                            root.column-chooser-x = self.absolute-position.x + self.mouse-x;
                                            root.column-chooser-y = self.absolute-position.y + self.mouse-y;
                                            root.show-column-chooser = !root.show-column-chooser;
                                        }
                                    }
                                }
                                HorizontalLayout {
                                    padding-left: 4px;
                                    Text { text: "Priority"; font-weight: 700; font-size: 12px; vertical-alignment: center; color: Palette.foreground; }
                                    Text { text: root.sort-column == 1 ? (root.sort-ascending ? " ▲" : " ▼") : ""; font-size: 10px; vertical-alignment: center; color: Palette.foreground.transparentize(30%); }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                            }

                            // === Type column ===
                            if root.show-col-type : Rectangle {
                                width: 5px;
                                background: mod-div1.has-hover || mod-div1.pressed ? Palette.accent-background : transparent;
                                mod-div1 := TouchArea {
                                    mouse-cursor: col-resize;
                                    moved => { root.mod-col-type-width = clamp(root.mod-col-type-width - (self.mouse-x - self.pressed-x), 20px, 300px); }
                                }
                            }
                            if root.show-col-type : Rectangle {
                                width: root.mod-col-type-width;
                                clip: true;
                                background: mod-col2-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                mod-col2-touch := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.sort-mods(2); }
                                    pointer-event(event) => {
                                        if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                                            root.column-chooser-x = self.absolute-position.x + self.mouse-x;
                                            root.column-chooser-y = self.absolute-position.y + self.mouse-y;
                                            root.show-column-chooser = !root.show-column-chooser;
                                        }
                                    }
                                }
                                HorizontalLayout {
                                    padding-left: 4px;
                                    Text { text: "Type"; font-weight: 700; font-size: 12px; vertical-alignment: center; color: Palette.foreground; }
                                    Text { text: root.sort-column == 2 ? (root.sort-ascending ? " ▲" : " ▼") : ""; font-size: 10px; vertical-alignment: center; color: Palette.foreground.transparentize(30%); }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                            }

                            // === Version column ===
                            if root.show-col-version : Rectangle {
                                width: 5px;
                                background: mod-div2.has-hover || mod-div2.pressed ? Palette.accent-background : transparent;
                                mod-div2 := TouchArea {
                                    mouse-cursor: col-resize;
                                    moved => { root.mod-col-version-width = clamp(root.mod-col-version-width - (self.mouse-x - self.pressed-x), 20px, 300px); }
                                }
                            }
                            if root.show-col-version : Rectangle {
                                width: root.mod-col-version-width;
                                clip: true;
                                background: mod-col3-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                mod-col3-touch := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.sort-mods(3); }
                                    pointer-event(event) => {
                                        if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                                            root.column-chooser-x = self.absolute-position.x + self.mouse-x;
                                            root.column-chooser-y = self.absolute-position.y + self.mouse-y;
                                            root.show-column-chooser = !root.show-column-chooser;
                                        }
                                    }
                                }
                                HorizontalLayout {
                                    padding-left: 4px;
                                    Text { text: "Version"; font-weight: 700; font-size: 12px; vertical-alignment: center; color: Palette.foreground; }
                                    Text { text: root.sort-column == 3 ? (root.sort-ascending ? " ▲" : " ▼") : ""; font-size: 10px; vertical-alignment: center; color: Palette.foreground.transparentize(30%); }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                            }

                            // === Nexus ID column ===
                            if root.show-col-nexus-id : Rectangle {
                                width: 5px;
                                background: mod-div-nxid.has-hover || mod-div-nxid.pressed ? Palette.accent-background : transparent;
                                mod-div-nxid := TouchArea {
                                    mouse-cursor: col-resize;
                                    moved => { root.mod-col-nexus-id-width = clamp(root.mod-col-nexus-id-width - (self.mouse-x - self.pressed-x), 20px, 300px); }
                                }
                            }
                            if root.show-col-nexus-id : Rectangle {
                                width: root.mod-col-nexus-id-width;
                                clip: true;
                                background: mod-col-nxid-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                mod-col-nxid-touch := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.sort-mods(8); }
                                    pointer-event(event) => {
                                        if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                                            root.column-chooser-x = self.absolute-position.x + self.mouse-x;
                                            root.column-chooser-y = self.absolute-position.y + self.mouse-y;
                                            root.show-column-chooser = !root.show-column-chooser;
                                        }
                                    }
                                }
                                HorizontalLayout {
                                    padding-left: 4px;
                                    Text { text: "Nexus ID"; font-weight: 700; font-size: 12px; vertical-alignment: center; color: Palette.foreground; }
                                    Text { text: root.sort-column == 8 ? (root.sort-ascending ? " ▲" : " ▼") : ""; font-size: 10px; vertical-alignment: center; color: Palette.foreground.transparentize(30%); }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                            }

                            // === Notes column ===
                            if root.show-col-notes : Rectangle {
                                width: 5px;
                                background: mod-div-notes.has-hover || mod-div-notes.pressed ? Palette.accent-background : transparent;
                                mod-div-notes := TouchArea {
                                    mouse-cursor: col-resize;
                                    moved => { root.mod-col-notes-width = clamp(root.mod-col-notes-width - (self.mouse-x - self.pressed-x), 20px, 300px); }
                                }
                            }
                            if root.show-col-notes : Rectangle {
                                width: root.mod-col-notes-width;
                                clip: true;
                                background: mod-col-notes-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                mod-col-notes-touch := TouchArea {
                                    mouse-cursor: pointer;
                                    clicked => { root.sort-mods(9); }
                                    pointer-event(event) => {
                                        if (event.button == PointerEventButton.right && event.kind == PointerEventKind.up) {
                                            root.column-chooser-x = self.absolute-position.x + self.mouse-x;
                                            root.column-chooser-y = self.absolute-position.y + self.mouse-y;
                                            root.show-column-chooser = !root.show-column-chooser;
                                        }
                                    }
                                }
                                HorizontalLayout {
                                    padding-left: 4px;
                                    Text { text: "Notes"; font-weight: 700; font-size: 12px; vertical-alignment: center; color: Palette.foreground; }
                                    Text { text: root.sort-column == 9 ? (root.sort-ascending ? " ▲" : " ▼") : ""; font-size: 10px; vertical-alignment: center; color: Palette.foreground.transparentize(30%); }
                                    Rectangle { horizontal-stretch: 1; }
                                }
                            }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: Palette.border;
                    }

                    // Mod list view (excludes Overwrite -- shown below)
                    // Use ScrollView + VerticalBox to avoid ListView delegate sizing issues.
                    ScrollView {
                        vertical-stretch: 1;

                        VerticalBox {
                            spacing: 0px;

                            for entry[index] in root.mod-list : Rectangle {
                                height: entry.is-overwrite ? 0px
                                    : entry.hidden-by-collapse ? 0px
                                    : entry.is-separator ? 32px : 28px;
                                visible: !entry.is-overwrite && !entry.hidden-by-collapse;

                                background: root.drag-active && index == root.drag-from-index
                                        ? Palette.accent-background.transparentize(50%)
                                    : root.drag-active && index == root.drag-to-index
                                        && root.drag-from-index != root.drag-to-index
                                        ? Palette.accent-background.transparentize(80%)
                                    : root.selected-mod-name == entry.name
                                        ? Palette.accent-background.transparentize(70%)
                                    : entry.is-separator ? #1a6e6e
                                    : entry.highlight-losing
                                        ? #f44336.transparentize(90%)
                                    : entry.highlight-winning
                                        ? #4caf50.transparentize(90%)
                                    : mod(index, 2) == 0 ? Palette.alternate-background
                                    : Palette.background;

                                TouchArea {
                                    mouse-cursor: root.drag-active ? move : default;
                                    pointer-event(event) => {
                                        if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                                            root.drag-from-index = index;
                                            root.drag-start-y = self.mouse-y;
                                            root.selected-mod-index = index;
                                            root.select-mod(entry.name);
                                        }
                                        if (event.kind == PointerEventKind.up && event.button == PointerEventButton.left) {
                                            if (root.drag-active && root.drag-from-index >= 0
                                                    && root.drag-to-index >= 0
                                                    && root.drag-from-index != root.drag-to-index) {
                                                root.reorder-mod(root.drag-from-index, root.drag-to-index);
                                            } else if (!root.drag-active && entry.is-separator && entry.separator-has-children) {
                                                root.toggle-separator-collapse(entry.name);
                                            }
                                            root.drag-active = false;
                                            root.drag-from-index = -1;
                                            root.drag-to-index = -1;
                                        }
                                        if (event.kind == PointerEventKind.up && event.button == PointerEventButton.right) {
                                            root.select-mod(entry.name);
                                            root.selected-mod-index = index;
                                            root.context-mod-is-separator = entry.is-separator;
                                            root.context-mod-enabled = entry.enabled;
                                            root.mod-context-menu-x = self.absolute-position.x + self.mouse-x;
                                            root.mod-context-menu-y = self.absolute-position.y + self.mouse-y;
                                            root.show-mod-context-menu = true;
                                        }
                                    }
                                    moved => {
                                        if (root.drag-from-index >= 0) {
                                            if (!root.drag-active
                                                    && (self.mouse-y - root.drag-start-y > 5px
                                                        || self.mouse-y - root.drag-start-y < -5px)) {
                                                root.drag-active = true;
                                            }
                                            if (root.drag-active) {
                                                root.drag-to-index = clamp(
                                                    root.drag-from-index
                                                        + round((self.mouse-y - root.drag-start-y) / 28px),
                                                    0,
                                                    root.mod-list.length - 1
                                                );
                                            }
                                        }
                                    }
                                }

                                // Drop target indicator line
                                if root.drag-active && index == root.drag-to-index
                                        && root.drag-from-index != root.drag-to-index : Rectangle {
                                    height: 3px;
                                    y: root.drag-to-index > root.drag-from-index
                                        ? parent.height - 3px : 0px;
                                    background: Palette.accent-background;
                                }

                                HorizontalLayout {
                                    padding-left: 4px;
                                    padding-right: 8px;
                                    spacing: 0px;

                                    if !entry.is-separator : CheckBox {
                                        width: 28px;
                                        checked: entry.enabled;
                                        toggled => { root.toggle-mod(entry.name); }
                                    }
                                    if entry.is-separator : Text {
                                        width: 28px;
                                        text: entry.separator-has-children ? (entry.is-collapsed ? "\u{25B6}" : "\u{25BC}") : "";
                                        color: #ffffff;
                                        font-size: 12px;
                                        vertical-alignment: center;
                                        horizontal-alignment: center;
                                    }

                                    // Mod Name (always visible)
                                    Text {
                                        text: entry.display-name;
                                        horizontal-stretch: 1;
                                        vertical-alignment: center;
                                        overflow: elide;
                                        color: entry.is-separator ? #ffffff
                                            : entry.enabled ? Palette.foreground
                                            : Palette.foreground.transparentize(50%);
                                        font-weight: entry.is-separator ? 700 : 400;
                                        font-italic: !entry.enabled && !entry.is-separator;
                                    }
                                    // Flags
                                    if root.show-col-flags : Text {
                                        text: entry.is-separator ? "" : entry.flags-text;
                                        width: root.mod-col-flags-width + 5px;
                                        vertical-alignment: center;
                                        horizontal-alignment: center;
                                        font-size: 11px;
                                        color: entry.has-losing ? #f44336
                                            : entry.has-winning ? #4caf50
                                            : entry.enabled ? Palette.foreground
                                            : Palette.foreground.transparentize(50%);
                                    }
                                    // Conflicts
                                    if root.show-col-conflicts : Text {
                                        text: entry.is-separator ? "" : entry.conflict-text;
                                        width: root.mod-col-conflicts-width + 5px;
                                        vertical-alignment: center;
                                        horizontal-alignment: center;
                                        font-size: 11px;
                                        color: entry.has-losing ? #f44336
                                            : entry.has-winning ? #4caf50
                                            : entry.enabled ? Palette.foreground
                                            : Palette.foreground.transparentize(50%);
                                    }
                                    // Category
                                    if root.show-col-category : Text {
                                        text: entry.is-separator ? "" : entry.category-name;
                                        width: root.mod-col-category-width + 5px;
                                        vertical-alignment: center;
                                        overflow: elide;
                                        font-size: 11px;
                                        color: entry.enabled ? Palette.foreground
                                            : Palette.foreground.transparentize(50%);
                                    }
                                    // Content
                                    if root.show-col-content : Text {
                                        text: entry.is-separator ? "" : entry.content-text;
                                        width: root.mod-col-content-width + 5px;
                                        vertical-alignment: center;
                                        horizontal-alignment: center;
                                        font-size: 10px;
                                        color: entry.enabled ? Palette.foreground.transparentize(20%)
                                            : Palette.foreground.transparentize(60%);
                                    }
                                    // Priority
                                    if root.show-col-priority : Text {
                                        text: entry.is-separator ? "" : entry.priority;
                                        width: root.mod-col-priority-width + 5px;
                                        vertical-alignment: center;
                                        horizontal-alignment: right;
                                        color: entry.enabled ? Palette.foreground
                                            : Palette.foreground.transparentize(50%);
                                    }
                                    // Type
                                    if root.show-col-type : Text {
                                        text: entry.is-separator ? "" : entry.mod-type;
                                        width: root.mod-col-type-width + 5px;
                                        vertical-alignment: center;
                                        horizontal-alignment: center;
                                        color: entry.enabled ? Palette.foreground
                                            : Palette.foreground.transparentize(50%);
                                    }
                                    // Version
                                    if root.show-col-version : Text {
                                        text: entry.is-separator ? "" : entry.version;
                                        width: root.mod-col-version-width + 5px;
                                        vertical-alignment: center;
                                        horizontal-alignment: right;
                                        overflow: elide;
                                        color: entry.enabled ? Palette.foreground
                                            : Palette.foreground.transparentize(50%);
                                    }
                                    // Nexus ID
                                    if root.show-col-nexus-id : Text {
                                        text: entry.is-separator || entry.nexus-id <= 0 ? "" : entry.nexus-id;
                                        width: root.mod-col-nexus-id-width + 5px;
                                        vertical-alignment: center;
                                        horizontal-alignment: right;
                                        font-size: 11px;
                                        color: entry.enabled ? Palette.foreground
                                            : Palette.foreground.transparentize(50%);
                                    }
                                    // Notes
                                    if root.show-col-notes : Text {
                                        text: entry.is-separator ? "" : entry.notes;
                                        width: root.mod-col-notes-width + 5px;
                                        vertical-alignment: center;
                                        overflow: elide;
                                        font-size: 11px;
                                        color: entry.enabled ? Palette.foreground.transparentize(20%)
                                            : Palette.foreground.transparentize(60%);
                                    }
                                }
                            }
                        }
                    }

                    // Overwrite folder -- pinned at bottom, distinct styling
                    Rectangle {
                        height: 1px;
                        background: Palette.border;
                    }
                    Rectangle {
                        height: 30px;
                        background: #3d2b1f;

                        HorizontalBox {
                            padding-left: 8px;
                            padding-right: 8px;
                            spacing: 8px;

                            Text {
                                text: "Overwrite";
                                vertical-alignment: center;
                                font-weight: 600;
                                font-size: 13px;
                                color: #e0a050;
                            }
                            Rectangle { horizontal-stretch: 1; }
                            Text {
                                text: "Files written by tools during VFS usage";
                                vertical-alignment: center;
                                font-size: 11px;
                                color: #e0a050.transparentize(40%);
                            }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: Palette.border;
                    }

                    // Filter bar at bottom
                    HorizontalBox {
                        height: 32px;
                        padding: 2px;
                        spacing: 4px;

                        Text {
                            text: "Filter";
                            vertical-alignment: center;
                            font-size: 12px;
                            color: Palette.foreground.transparentize(30%);
                        }
                        filter-input := LineEdit {
                            horizontal-stretch: 1;
                            placeholder-text: "Type to filter mods...";
                            edited(value) => {
                                root.filter-text = value;
                                root.filter-mods(value);
                            }
                        }
                        Text {
                            text: root.enabled-mod-count + " / " + root.mod-count;
                            vertical-alignment: center;
                            font-size: 11px;
                            color: Palette.foreground.transparentize(30%);
                        }
                        Button {
                            text: "Install...";
                            clicked => { root.mod-context-action("install-mod"); }
                        }
                    }

                    // Conflict info bar — shows details for selected mod
                    if root.selected-mod-winning != "" || root.selected-mod-losing != "" : Rectangle {
                        height: conflict-info-col.preferred-height + 8px;
                        background: Palette.alternate-background;
                        border-width: 1px;
                        border-color: Palette.border;
                        border-radius: 3px;

                        conflict-info-col := VerticalLayout {
                            padding: 4px;
                            padding-left: 8px;
                            spacing: 2px;

                            if root.selected-mod-winning != "" : HorizontalLayout {
                                spacing: 4px;
                                Text {
                                    text: "Wins over:";
                                    font-size: 10px;
                                    font-weight: 700;
                                    color: #4caf50;
                                    vertical-alignment: center;
                                }
                                Text {
                                    text: root.selected-mod-winning;
                                    font-size: 10px;
                                    color: Palette.foreground.transparentize(20%);
                                    overflow: elide;
                                    vertical-alignment: center;
                                }
                            }
                            if root.selected-mod-losing != "" : HorizontalLayout {
                                spacing: 4px;
                                Text {
                                    text: "Loses to:";
                                    font-size: 10px;
                                    font-weight: 700;
                                    color: #f44336;
                                    vertical-alignment: center;
                                }
                                Text {
                                    text: root.selected-mod-losing;
                                    font-size: 10px;
                                    color: Palette.foreground.transparentize(20%);
                                    overflow: elide;
                                    vertical-alignment: center;
                                }
                            }
                        }
                    }
                    } // close VerticalLayout
                } // close mod list Rectangle

                // Draggable splitter
                Rectangle {
                    width: 6px;
                    background: splitter-touch.has-hover || splitter-touch.pressed
                        ? Palette.accent-background : Palette.border;

                    splitter-touch := TouchArea {
                        mouse-cursor: col-resize;
                        pointer-event(event) => {
                            if (event.kind == PointerEventKind.down) {
                                root.split-drag-start = root.split-ratio;
                            }
                        }
                        moved => {
                            root.split-ratio = clamp(
                                root.split-drag-start + (self.mouse-x - self.pressed-x) / content-area.width,
                                0.25,
                                0.66
                            );
                        }
                    }
                }

                // --- Right: Executable Selector + Tab Panel ---
                VerticalBox {
                    min-width: 430px;
                    horizontal-stretch: 1;

                    // Executable selector row
                    HorizontalBox {
                        height: 40px;
                        padding: 4px;
                        spacing: 4px;

                        toolbar-tool-combo := ComboBox {
                            horizontal-stretch: 1;
                            min-width: 0px;
                            model: root.toolbar-tools;
                            current-value: root.selected-toolbar-tool;
                            selected(value) => { root.selected-toolbar-tool = value; }
                        }
                        Button {
                            text: root.locked ? "Locked" : "Run";
                            enabled: root.has-toolbar-tools && !root.locked;
                            clicked => { root.play(); }
                        }
                        Button {
                            text: "Edit...";
                            clicked => { root.open-tool-editor(); }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: Palette.border;
                    }

                    // Tab panel
                    TabWidget {
                        Tab {
                            title: "Plugins";
                            VerticalBox {
                                padding: 0;
                                spacing: 0;

                                // Column headers with hover + drag-resize dividers (same as mod list)
                                Rectangle {
                                    height: 32px;
                                    background: Palette.alternate-background;

                                    HorizontalLayout {
                                        padding-left: 32px;
                                        padding-right: 8px;

                                        // Plugin Name (flush left, fills remaining space)
                                        Rectangle {
                                            horizontal-stretch: 1;
                                            background: plg-col0-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                            plg-col0-touch := TouchArea {
                                                mouse-cursor: pointer;
                                                clicked => { root.sort-plugins(0); }
                                            }
                                            HorizontalLayout {
                                                padding-left: 4px;
                                                Text {
                                                    text: "Plugin Name";
                                                    font-weight: 700;
                                                    font-size: 12px;
                                                    vertical-alignment: center;
                                                    color: Palette.foreground;
                                                }
                                                Text {
                                                    text: root.plugin-sort-column == 0 ? (root.plugin-sort-ascending ? " ▲" : " ▼") : "";
                                                    font-size: 10px;
                                                    vertical-alignment: center;
                                                    color: Palette.foreground.transparentize(30%);
                                                }
                                                Rectangle { horizontal-stretch: 1; }
                                            }
                                        }

                                        // Divider: Name | Priority (non-draggable to prevent overflow)
                                        Rectangle {
                                            width: 1px;
                                            background: Palette.border;
                                        }

                                        // Priority
                                        Rectangle {
                                            width: root.plg-col-priority-width;
                                            background: plg-col1-touch.has-hover ? Palette.foreground.transparentize(90%) : transparent;
                                            plg-col1-touch := TouchArea {
                                                mouse-cursor: pointer;
                                                clicked => { root.sort-plugins(1); }
                                            }
                                            HorizontalLayout {
                                                padding-left: 4px;
                                                Text {
                                                    text: "Priority";
                                                    font-weight: 700;
                                                    font-size: 12px;
                                                    vertical-alignment: center;
                                                    color: Palette.foreground;
                                                }
                                                Text {
                                                    text: root.plugin-sort-column == 1 ? (root.plugin-sort-ascending ? " ▲" : " ▼") : "";
                                                    font-size: 10px;
                                                    vertical-alignment: center;
                                                    color: Palette.foreground.transparentize(30%);
                                                }
                                                Rectangle { horizontal-stretch: 1; }
                                            }
                                        }

                                        // Plugin Name + Priority only for compact layout at 1200x700.
                                    }
                                }

                                Rectangle {
                                    height: 1px;
                                    background: Palette.border;
                                }

                                // Plugin list view
                                ListView {
                                    vertical-stretch: 1;

                                    for plugin[index] in root.plugin-list : Rectangle {
                                        height: 26px;
                                        background: root.plg-drag-active && index == root.plg-drag-from-index
                                                ? Palette.accent-background.transparentize(50%)
                                            : root.plg-drag-active && index == root.plg-drag-to-index
                                                && root.plg-drag-from-index != root.plg-drag-to-index
                                                ? Palette.accent-background.transparentize(80%)
                                            : mod(index, 2) == 0 ? Palette.alternate-background
                                            : Palette.background;

                                        TouchArea {
                                            mouse-cursor: root.plg-drag-active ? move : default;
                                            pointer-event(event) => {
                                                if (event.kind == PointerEventKind.down && event.button == PointerEventButton.left) {
                                                    root.plg-drag-from-index = index;
                                                    root.plg-drag-start-y = self.mouse-y;
                                                }
                                                if (event.kind == PointerEventKind.up && event.button == PointerEventButton.left) {
                                                    if (root.plg-drag-active && root.plg-drag-from-index >= 0
                                                            && root.plg-drag-to-index >= 0
                                                            && root.plg-drag-from-index != root.plg-drag-to-index) {
                                                        root.reorder-plugin(root.plg-drag-from-index, root.plg-drag-to-index);
                                                    }
                                                    root.plg-drag-active = false;
                                                    root.plg-drag-from-index = -1;
                                                    root.plg-drag-to-index = -1;
                                                }
                                                if (event.kind == PointerEventKind.up && event.button == PointerEventButton.right) {
                                                    root.context-plugin-name = plugin.filename;
                                                    root.context-plugin-enabled = plugin.enabled;
                                                    root.plugin-context-menu-x = self.absolute-position.x + self.mouse-x;
                                                    root.plugin-context-menu-y = self.absolute-position.y + self.mouse-y;
                                                    root.show-plugin-context-menu = true;
                                                }
                                            }
                                            moved => {
                                                if (root.plg-drag-from-index >= 0) {
                                                    if (!root.plg-drag-active
                                                            && (self.mouse-y - root.plg-drag-start-y > 5px
                                                                || self.mouse-y - root.plg-drag-start-y < -5px)) {
                                                        root.plg-drag-active = true;
                                                    }
                                                    if (root.plg-drag-active) {
                                                        root.plg-drag-to-index = clamp(
                                                            root.plg-drag-from-index
                                                                + round((self.mouse-y - root.plg-drag-start-y) / 26px),
                                                            0,
                                                            root.plugin-list.length - 1
                                                        );
                                                    }
                                                }
                                            }
                                        }

                                        // Drop target indicator line
                                        if root.plg-drag-active && index == root.plg-drag-to-index
                                                && root.plg-drag-from-index != root.plg-drag-to-index : Rectangle {
                                            height: 3px;
                                            y: root.plg-drag-to-index > root.plg-drag-from-index
                                                ? parent.height - 3px : 0px;
                                            background: Palette.accent-background;
                                        }

                                        HorizontalLayout {
                                            padding-left: 4px;
                                            padding-right: 8px;
                                            spacing: 0px;

                                            CheckBox {
                                                width: 28px;
                                                checked: plugin.enabled;
                                                toggled => { root.toggle-plugin(plugin.filename); }
                                            }

                                            Text {
                                                text: plugin.filename;
                                                horizontal-stretch: 1;
                                                vertical-alignment: center;
                                                overflow: elide;
                                                font-weight: plugin.is-master ? 700 : 400;
                                                color: plugin.enabled ? Palette.foreground
                                                    : Palette.foreground.transparentize(50%);
                                            }
                                            Text {
                                                text: plugin.priority;
                                                width: root.plg-col-priority-width + 5px;
                                                vertical-alignment: center;
                                                horizontal-alignment: right;
                                                color: plugin.enabled ? Palette.foreground
                                                    : Palette.foreground.transparentize(50%);
                                            }
                                        }
                                    }
                                }

                                Rectangle {
                                    height: 1px;
                                    background: Palette.border;
                                }

                                // Filter bar with plugin count
                                HorizontalBox {
                                    height: 32px;
                                    padding: 2px;
                                    spacing: 4px;

                                    Text {
                                        text: "Filter";
                                        vertical-alignment: center;
                                        font-size: 12px;
                                        color: Palette.foreground.transparentize(30%);
                                    }
                                    plugin-filter-input := LineEdit {
                                        horizontal-stretch: 1;
                                        placeholder-text: "Type to filter plugins...";
                                        edited(value) => {
                                            root.plugin-filter-text = value;
                                            root.filter-plugins(value);
                                        }
                                    }
                                    Text {
                                        text: root.enabled-plugin-count + " / " + root.plugin-count;
                                        vertical-alignment: center;
                                        font-size: 11px;
                                        color: Palette.foreground.transparentize(30%);
                                    }
                                }
                            }
                        }
                        // ===== Archives Tab =====
                        Tab {
                            title: "Archives";
                            VerticalLayout {
                                spacing: 0px;
                                // --- Header ---
                                Rectangle {
                                    height: 30px;
                                    background: Palette.background.darker(0.05);
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        padding-right: 8px;
                                        spacing: 8px;
                                        alignment: start;
                                        Text {
                                            text: "Archives (" + root.archive-count + ")";
                                            vertical-alignment: center;
                                            font-weight: 700;
                                            font-size: 12px;
                                        }
                                        Rectangle { horizontal-stretch: 1; }
                                        Rectangle {
                                            width: 150px;
                                            height: 24px;
                                            border-radius: 3px;
                                            border-width: 1px;
                                            border-color: Palette.border;
                                            background: Palette.background;
                                            HorizontalLayout {
                                                padding-left: 4px;
                                                padding-right: 4px;
                                                Text {
                                                    text: "🔍";
                                                    width: 16px;
                                                    vertical-alignment: center;
                                                    font-size: 10px;
                                                }
                                                archive-filter := LineEdit {
                                                    placeholder-text: "Filter...";
                                                    edited(text) => { root.filter-archives(text); }
                                                }
                                            }
                                        }
                                    }
                                }
                                // --- Column headers ---
                                Rectangle {
                                    height: 24px;
                                    background: Palette.background.darker(0.1);
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        spacing: 0px;
                                        Text {
                                            text: "Archive";
                                            width: 280px;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                        Text {
                                            text: "Origin Mod";
                                            horizontal-stretch: 1;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                                Rectangle { height: 1px; background: Palette.border; }
                                // --- Archive list ---
                                ListView {
                                    for entry[idx] in root.archive-list : Rectangle {
                                        height: 26px;
                                        background: mod(idx, 2) == 0 ? transparent : Palette.background.darker(0.03);
                                        HorizontalLayout {
                                            padding-left: 8px;
                                            spacing: 4px;
                                            // Mod enabled indicator
                                            Rectangle {
                                                width: 8px;
                                                height: 8px;
                                                border-radius: 4px;
                                                background: entry.mod-enabled ? #4caf50 : #f44336;
                                            }
                                            Text {
                                                text: entry.filename;
                                                width: 268px;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                overflow: elide;
                                                color: entry.mod-enabled ? Palette.foreground : Palette.foreground.transparentize(50%);
                                            }
                                            Text {
                                                text: entry.origin-mod;
                                                horizontal-stretch: 1;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                overflow: elide;
                                                color: Palette.foreground.transparentize(30%);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        // ===== Data Tab =====
                        Tab {
                            title: "Data";
                            VerticalLayout {
                                spacing: 0px;
                                // --- Header ---
                                Rectangle {
                                    height: 30px;
                                    background: Palette.background.darker(0.05);
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        padding-right: 8px;
                                        spacing: 8px;
                                        alignment: start;
                                        Text {
                                            text: "Virtual Filesystem (" + root.data-file-count + " files)";
                                            vertical-alignment: center;
                                            font-weight: 700;
                                            font-size: 12px;
                                        }
                                        Rectangle { horizontal-stretch: 1; }
                                        Rectangle {
                                            width: 150px;
                                            height: 24px;
                                            border-radius: 3px;
                                            border-width: 1px;
                                            border-color: Palette.border;
                                            background: Palette.background;
                                            HorizontalLayout {
                                                padding-left: 4px;
                                                padding-right: 4px;
                                                Text {
                                                    text: "🔍";
                                                    width: 16px;
                                                    vertical-alignment: center;
                                                    font-size: 10px;
                                                }
                                                data-filter := LineEdit {
                                                    placeholder-text: "Filter...";
                                                    edited(text) => { root.filter-data(text); }
                                                }
                                            }
                                        }
                                    }
                                }
                                // --- Column headers ---
                                Rectangle {
                                    height: 24px;
                                    background: Palette.background.darker(0.1);
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        spacing: 0px;
                                        Text {
                                            text: "Name";
                                            width: 300px;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                        Text {
                                            text: "Origin";
                                            width: 160px;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                        Text {
                                            text: "Size";
                                            horizontal-stretch: 1;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                                Rectangle { height: 1px; background: Palette.border; }
                                // --- Data tree ---
                                ListView {
                                    for entry[idx] in root.data-list : Rectangle {
                                        height: 24px;
                                        background: mod(idx, 2) == 0 ? transparent : Palette.background.darker(0.03);
                                        HorizontalLayout {
                                            padding-left: 8px + entry.depth * 16px;
                                            spacing: 4px;
                                            // Expand/collapse for directories
                                            if entry.is-directory : TouchArea {
                                                width: 16px;
                                                mouse-cursor: pointer;
                                                clicked => { root.toggle-data-expand(idx); }
                                                Text {
                                                    text: entry.is-expanded ? "▼" : "▶";
                                                    font-size: 9px;
                                                    vertical-alignment: center;
                                                    horizontal-alignment: center;
                                                    color: Palette.foreground.transparentize(30%);
                                                }
                                            }
                                            if !entry.is-directory : Rectangle {
                                                width: 16px;
                                            }
                                            Text {
                                                text: entry.name;
                                                width: 300px - 24px - entry.depth * 16px;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                font-weight: entry.is-directory ? 700 : 400;
                                                overflow: elide;
                                                color: entry.is-directory ? Palette.foreground : Palette.foreground.transparentize(10%);
                                            }
                                            Text {
                                                text: entry.origin;
                                                width: 160px;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                overflow: elide;
                                                color: Palette.foreground.transparentize(30%);
                                            }
                                            Text {
                                                text: entry.size;
                                                horizontal-stretch: 1;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                color: Palette.foreground.transparentize(30%);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        // ===== Saves Tab =====
                        Tab {
                            title: "Saves";
                            VerticalLayout {
                                spacing: 0px;
                                // --- Header ---
                                Rectangle {
                                    height: 30px;
                                    background: Palette.background.darker(0.05);
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        padding-right: 8px;
                                        spacing: 8px;
                                        alignment: start;
                                        Text {
                                            text: "Saves (" + root.save-count + ")";
                                            vertical-alignment: center;
                                            font-weight: 700;
                                            font-size: 12px;
                                        }
                                    }
                                }
                                // --- Column headers ---
                                Rectangle {
                                    height: 24px;
                                    background: Palette.background.darker(0.1);
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        spacing: 0px;
                                        Text {
                                            text: "Filename";
                                            width: 220px;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                        Text {
                                            text: "Character";
                                            width: 120px;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                        Text {
                                            text: "Date";
                                            width: 140px;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                        Text {
                                            text: "Size";
                                            horizontal-stretch: 1;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                                Rectangle { height: 1px; background: Palette.border; }
                                // --- Save list ---
                                if root.save-count > 0 : ListView {
                                    for entry[idx] in root.save-list : Rectangle {
                                        height: 26px;
                                        background: mod(idx, 2) == 0 ? transparent : Palette.background.darker(0.03);
                                        HorizontalLayout {
                                            padding-left: 8px;
                                            spacing: 0px;
                                            Text {
                                                text: entry.filename;
                                                width: 220px;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                overflow: elide;
                                            }
                                            Text {
                                                text: entry.character;
                                                width: 120px;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                overflow: elide;
                                                color: Palette.foreground.transparentize(20%);
                                            }
                                            Text {
                                                text: entry.date-text;
                                                width: 140px;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                color: Palette.foreground.transparentize(30%);
                                            }
                                            Text {
                                                text: entry.size-text;
                                                horizontal-stretch: 1;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                color: Palette.foreground.transparentize(30%);
                                            }
                                        }
                                    }
                                }
                                if root.save-count == 0 : VerticalBox {
                                    Text {
                                        text: "No saves found.\nEnable Local Saves in profile settings\nor configure a game path.";
                                        vertical-alignment: center;
                                        horizontal-alignment: center;
                                        color: Palette.foreground.transparentize(50%);
                                        font-size: 12px;
                                    }
                                }
                            }
                        }
                        // ===== Downloads Tab =====
                        Tab {
                            title: "Downloads";
                            VerticalLayout {
                                spacing: 0px;
                                // --- Header ---
                                Rectangle {
                                    height: 30px;
                                    background: Palette.background.darker(0.05);
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        padding-right: 8px;
                                        spacing: 8px;
                                        alignment: start;
                                        Text {
                                            text: "Downloads (" + root.download-count + ")";
                                            vertical-alignment: center;
                                            font-weight: 700;
                                            font-size: 12px;
                                        }
                                    }
                                }
                                // --- Column headers ---
                                Rectangle {
                                    height: 24px;
                                    background: Palette.background.darker(0.1);
                                    HorizontalLayout {
                                        padding-left: 8px;
                                        spacing: 0px;
                                        Text {
                                            text: "Filename";
                                            width: 300px;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                        Text {
                                            text: "Version";
                                            width: 80px;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                        Text {
                                            text: "Size";
                                            width: 80px;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                        Text {
                                            text: "Status";
                                            horizontal-stretch: 1;
                                            font-weight: 700;
                                            font-size: 11px;
                                            vertical-alignment: center;
                                        }
                                    }
                                }
                                Rectangle { height: 1px; background: Palette.border; }
                                // --- Download list ---
                                if root.download-count > 0 : ListView {
                                    for entry[idx] in root.download-list : Rectangle {
                                        height: 26px;
                                        background: mod(idx, 2) == 0 ? transparent : Palette.background.darker(0.03);
                                        HorizontalLayout {
                                            padding-left: 8px;
                                            spacing: 0px;
                                            Text {
                                                text: entry.filename;
                                                width: 300px;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                overflow: elide;
                                            }
                                            Text {
                                                text: entry.version;
                                                width: 80px;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                color: Palette.foreground.transparentize(20%);
                                            }
                                            Text {
                                                text: entry.size-text;
                                                width: 80px;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                color: Palette.foreground.transparentize(30%);
                                            }
                                            Text {
                                                text: entry.installed ? "Installed" : "Not installed";
                                                horizontal-stretch: 1;
                                                vertical-alignment: center;
                                                font-size: 11px;
                                                color: entry.installed ? #4caf50 : Palette.foreground.transparentize(40%);
                                            }
                                        }
                                    }
                                }
                                if root.download-count == 0 : VerticalBox {
                                    Text {
                                        text: "No downloads found.";
                                        vertical-alignment: center;
                                        horizontal-alignment: center;
                                        color: Palette.foreground.transparentize(50%);
                                        font-size: 12px;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // ===== Status Bar =====
            Rectangle {
                height: 1px;
                background: Palette.border;
            }

            HorizontalBox {
                height: 24px;
                padding-left: 8px;
                padding-right: 8px;

                Text {
                    text: root.instance-display-path != "" ?
                        root.instance-display-path + "  •  " + root.game-name
                        : "No instance loaded";
                    vertical-alignment: center;
                    color: Palette.foreground.transparentize(20%);
                    font-size: 12px;
                    overflow: elide;
                }
            }
        }

        // ===== Menu Dropdown Overlays =====
        if root.open-menu >= 0 : Rectangle {
            background: transparent;

            // Dismiss backdrop
            TouchArea {
                clicked => { root.open-menu = -1; }
            }

            // File menu dropdown
            if root.open-menu == 0 : Rectangle {
                x: 4px;
                y: 28px;
                width: 160px;
                height: 91px;
                background: Palette.background;
                border-radius: 4px;
                border-width: 1px;
                border-color: Palette.border;
                drop-shadow-blur: 6px;
                drop-shadow-color: #000000.transparentize(75%);
                clip: true;

                VerticalLayout {
                    padding: 2px;
                    spacing: 0px;

                    Rectangle {
                        height: 28px;
                        background: menu-import-touch.has-hover ? Palette.accent-background : transparent;
                        menu-import-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.menu-action("import"); root.open-menu = -1; }
                        }
                        HorizontalLayout { padding-left: 12px; Text { text: "Import MO2..."; font-size: 12px; vertical-alignment: center; color: Palette.foreground; } }
                    }
                    Rectangle {
                        height: 28px;
                        background: menu-refresh-touch.has-hover ? Palette.accent-background : transparent;
                        menu-refresh-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.menu-action("refresh"); root.open-menu = -1; }
                        }
                        HorizontalLayout { padding-left: 12px; Text { text: "Refresh"; font-size: 12px; vertical-alignment: center; color: Palette.foreground; } }
                    }
                    Rectangle { height: 1px; background: Palette.border; }
                    Rectangle {
                        height: 28px;
                        background: menu-quit-touch.has-hover ? Palette.accent-background : transparent;
                        menu-quit-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.menu-action("quit"); root.open-menu = -1; }
                        }
                        HorizontalLayout { padding-left: 12px; Text { text: "Quit"; font-size: 12px; vertical-alignment: center; color: Palette.foreground; } }
                    }
                }
            }

            // Tools menu dropdown
            if root.open-menu == 1 : Rectangle {
                x: 54px;
                y: 28px;
                width: 160px;
                height: 62px;
                background: Palette.background;
                border-radius: 4px;
                border-width: 1px;
                border-color: Palette.border;
                drop-shadow-blur: 6px;
                drop-shadow-color: #000000.transparentize(75%);
                clip: true;

                VerticalLayout {
                    padding: 2px;
                    spacing: 0px;

                    Rectangle {
                        height: 28px;
                        background: menu-exes-touch.has-hover ? Palette.accent-background : transparent;
                        menu-exes-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.menu-action("executables"); root.open-menu = -1; }
                        }
                        HorizontalLayout { padding-left: 12px; Text { text: "Executables..."; font-size: 12px; vertical-alignment: center; color: Palette.foreground; } }
                    }
                    Rectangle {
                        height: 28px;
                        background: menu-settings-touch.has-hover ? Palette.accent-background : transparent;
                        menu-settings-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.menu-action("settings"); root.open-menu = -1; }
                        }
                        HorizontalLayout { padding-left: 12px; Text { text: "Settings..."; font-size: 12px; vertical-alignment: center; color: Palette.foreground; } }
                    }
                }
            }

            // View menu dropdown
            if root.open-menu == 2 : Rectangle {
                x: 109px;
                y: 28px;
                width: 180px;
                height: 34px;
                background: Palette.background;
                border-radius: 4px;
                border-width: 1px;
                border-color: Palette.border;
                drop-shadow-blur: 6px;
                drop-shadow-color: #000000.transparentize(75%);
                clip: true;

                VerticalLayout {
                    padding: 2px;
                    spacing: 0px;

                    Rectangle {
                        height: 28px;
                        background: menu-filters-touch.has-hover ? Palette.accent-background : transparent;
                        menu-filters-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.menu-action("toggle-filters"); root.open-menu = -1; }
                        }
                        HorizontalLayout {
                            padding-left: 12px;
                            Text {
                                text: root.show-filter-panel ? "Hide Filter Panel" : "Show Filter Panel";
                                font-size: 12px;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                        }
                    }
                }
            }

            // Help menu dropdown
            if root.open-menu == 3 : Rectangle {
                x: 159px;
                y: 28px;
                width: 140px;
                height: 34px;
                background: Palette.background;
                border-radius: 4px;
                border-width: 1px;
                border-color: Palette.border;
                drop-shadow-blur: 6px;
                drop-shadow-color: #000000.transparentize(75%);
                clip: true;

                VerticalLayout {
                    padding: 2px;
                    spacing: 0px;

                    Rectangle {
                        height: 28px;
                        background: menu-about-touch.has-hover ? Palette.accent-background : transparent;
                        menu-about-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.menu-action("about"); root.open-menu = -1; }
                        }
                        HorizontalLayout { padding-left: 12px; Text { text: "About MO2 Linux"; font-size: 12px; vertical-alignment: center; color: Palette.foreground; } }
                    }
                }
            }
        }

        // ===== Column Chooser Popup =====
        if root.show-column-chooser : Rectangle {
            background: transparent;

            // Dismiss backdrop
            TouchArea {
                clicked => { root.show-column-chooser = false; }
            }

            // Popup panel positioned at the right-click location
            Rectangle {
                x: root.column-chooser-x;
                y: root.column-chooser-y;
                width: 180px;
                height: 280px;
                background: Palette.background;
                border-radius: 6px;
                border-width: 1px;
                border-color: Palette.border;
                drop-shadow-blur: 8px;
                drop-shadow-color: #000000.transparentize(70%);
                clip: true;

                VerticalBox {
                    padding: 8px;
                    spacing: 2px;

                    Text {
                        text: "Show Columns";
                        font-weight: 700;
                        font-size: 12px;
                        color: Palette.foreground;
                    }

                    Rectangle { height: 4px; }

                    CheckBox {
                        text: "Flags";
                        checked: root.show-col-flags;
                        toggled => { root.show-col-flags = self.checked; }
                    }
                    CheckBox {
                        text: "Conflicts";
                        checked: root.show-col-conflicts;
                        toggled => { root.show-col-conflicts = self.checked; }
                    }
                    CheckBox {
                        text: "Category";
                        checked: root.show-col-category;
                        toggled => { root.show-col-category = self.checked; }
                    }
                    CheckBox {
                        text: "Content";
                        checked: root.show-col-content;
                        toggled => { root.show-col-content = self.checked; }
                    }
                    CheckBox {
                        text: "Priority";
                        checked: root.show-col-priority;
                        toggled => { root.show-col-priority = self.checked; }
                    }
                    CheckBox {
                        text: "Type";
                        checked: root.show-col-type;
                        toggled => { root.show-col-type = self.checked; }
                    }
                    CheckBox {
                        text: "Version";
                        checked: root.show-col-version;
                        toggled => { root.show-col-version = self.checked; }
                    }
                    CheckBox {
                        text: "Nexus ID";
                        checked: root.show-col-nexus-id;
                        toggled => { root.show-col-nexus-id = self.checked; }
                    }
                    CheckBox {
                        text: "Notes";
                        checked: root.show-col-notes;
                        toggled => { root.show-col-notes = self.checked; }
                    }

                    Rectangle { vertical-stretch: 1; }
                }
            }
        }

        // ===== Mod Context Menu Popup =====
        if root.show-mod-context-menu : Rectangle {
            background: transparent;

            // Dismiss backdrop
            TouchArea {
                clicked => { root.show-mod-context-menu = false; }
            }

            // Popup panel positioned at the right-click location
            Rectangle {
                x: root.mod-context-menu-x;
                y: root.mod-context-menu-y;
                width: 200px;
                height: root.context-mod-is-separator ? 168px : 236px;
                background: Palette.background;
                border-radius: 6px;
                border-width: 1px;
                border-color: Palette.border;
                drop-shadow-blur: 8px;
                drop-shadow-color: #000000.transparentize(70%);
                clip: true;

                VerticalLayout {
                    padding: 4px;
                    spacing: 0px;

                    // --- Install Mod (always available) ---
                    Rectangle {
                        height: 28px;
                        background: ctx-install-touch.has-hover ? Palette.accent-background.transparentize(70%) : transparent;
                        border-radius: 4px;
                        ctx-install-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.mod-context-action("install-mod"); root.show-mod-context-menu = false; }
                        }
                        HorizontalLayout {
                            padding-left: 12px;
                            Text {
                                text: "Install Mod...";
                                font-size: 12px;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                        }
                    }

                    // --- Create Separator (always available) ---
                    Rectangle {
                        height: 28px;
                        background: ctx-newsep-touch.has-hover ? Palette.accent-background.transparentize(70%) : transparent;
                        border-radius: 4px;
                        ctx-newsep-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.mod-context-action("create-separator"); root.show-mod-context-menu = false; }
                        }
                        HorizontalLayout {
                            padding-left: 12px;
                            Text {
                                text: "Create Separator";
                                font-size: 12px;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                        }
                    }

                    Rectangle { height: 1px; background: Palette.border; }
                    Rectangle { height: 4px; }

                    // --- Regular mod items ---
                    if !root.context-mod-is-separator : Rectangle {
                        height: 28px;
                        background: ctx-toggle-touch.has-hover ? Palette.accent-background.transparentize(70%) : transparent;
                        border-radius: 4px;
                        ctx-toggle-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.mod-context-action("toggle"); root.show-mod-context-menu = false; }
                        }
                        HorizontalLayout {
                            padding-left: 12px;
                            Text {
                                text: root.context-mod-enabled ? "Disable" : "Enable";
                                font-size: 12px;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                        }
                    }
                    if !root.context-mod-is-separator : Rectangle {
                        height: 28px;
                        background: ctx-rename-touch.has-hover ? Palette.accent-background.transparentize(70%) : transparent;
                        border-radius: 4px;
                        ctx-rename-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.mod-context-action("rename"); root.show-mod-context-menu = false; }
                        }
                        HorizontalLayout {
                            padding-left: 12px;
                            Text {
                                text: "Rename...";
                                font-size: 12px;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                        }
                    }
                    if !root.context-mod-is-separator : Rectangle {
                        height: 28px;
                        background: ctx-open-touch.has-hover ? Palette.accent-background.transparentize(70%) : transparent;
                        border-radius: 4px;
                        ctx-open-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.mod-context-action("open-folder"); root.show-mod-context-menu = false; }
                        }
                        HorizontalLayout {
                            padding-left: 12px;
                            Text {
                                text: "Open Folder";
                                font-size: 12px;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                        }
                    }
                    if !root.context-mod-is-separator : Rectangle {
                        height: 1px;
                        background: Palette.border;
                    }
                    if !root.context-mod-is-separator : Rectangle {
                        height: 4px;
                    }
                    if !root.context-mod-is-separator : Rectangle {
                        height: 28px;
                        background: ctx-delete-touch.has-hover ? #f44336.transparentize(70%) : transparent;
                        border-radius: 4px;
                        ctx-delete-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.mod-context-action("delete"); root.show-mod-context-menu = false; }
                        }
                        HorizontalLayout {
                            padding-left: 12px;
                            Text {
                                text: "Delete Mod";
                                font-size: 12px;
                                vertical-alignment: center;
                                color: #f44336;
                            }
                        }
                    }

                    // --- Separator items ---
                    if root.context-mod-is-separator : Rectangle {
                        height: 28px;
                        background: ctx-sep-rename-touch.has-hover ? Palette.accent-background.transparentize(70%) : transparent;
                        border-radius: 4px;
                        ctx-sep-rename-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.mod-context-action("rename-sep"); root.show-mod-context-menu = false; }
                        }
                        HorizontalLayout {
                            padding-left: 12px;
                            Text {
                                text: "Rename Separator";
                                font-size: 12px;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                        }
                    }
                    if root.context-mod-is-separator : Rectangle {
                        height: 1px;
                        background: Palette.border;
                    }
                    if root.context-mod-is-separator : Rectangle {
                        height: 4px;
                    }
                    if root.context-mod-is-separator : Rectangle {
                        height: 28px;
                        background: ctx-sep-delete-touch.has-hover ? #f44336.transparentize(70%) : transparent;
                        border-radius: 4px;
                        ctx-sep-delete-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.mod-context-action("delete-sep"); root.show-mod-context-menu = false; }
                        }
                        HorizontalLayout {
                            padding-left: 12px;
                            Text {
                                text: "Delete Separator";
                                font-size: 12px;
                                vertical-alignment: center;
                                color: #f44336;
                            }
                        }
                    }
                }
            }
        }

        // ===== Plugin Context Menu Popup =====
        if root.show-plugin-context-menu : Rectangle {
            background: transparent;

            TouchArea {
                clicked => { root.show-plugin-context-menu = false; }
            }

            Rectangle {
                x: root.plugin-context-menu-x;
                y: root.plugin-context-menu-y;
                width: 180px;
                height: 36px;
                background: Palette.background;
                border-radius: 6px;
                border-width: 1px;
                border-color: Palette.border;
                drop-shadow-blur: 8px;
                drop-shadow-color: #000000.transparentize(70%);
                clip: true;

                VerticalLayout {
                    padding: 4px;
                    spacing: 0px;

                    Rectangle {
                        height: 28px;
                        background: ctx-plg-toggle-touch.has-hover ? Palette.accent-background.transparentize(70%) : transparent;
                        border-radius: 4px;
                        ctx-plg-toggle-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => { root.plugin-context-action("toggle"); root.show-plugin-context-menu = false; }
                        }
                        HorizontalLayout {
                            padding-left: 12px;
                            Text {
                                text: root.context-plugin-enabled ? "Disable" : "Enable";
                                font-size: 12px;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                        }
                    }
                }
            }
        }

        // ===== Rename Overlay Dialog =====
        if root.show-rename-dialog : Rectangle {
            background: #000000.transparentize(50%);

            TouchArea {
                clicked => { root.show-rename-dialog = false; }
            }

            Rectangle {
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                width: 420px;
                height: 160px;
                background: Palette.background;
                border-radius: 8px;
                border-width: 1px;
                border-color: Palette.border;
                drop-shadow-blur: 8px;
                drop-shadow-color: #000000.transparentize(70%);

                VerticalLayout {
                    padding: 16px;
                    spacing: 12px;

                    Text {
                        text: root.rename-dialog-title;
                        font-size: 16px;
                        font-weight: 700;
                        color: Palette.foreground;
                    }

                    rename-input := LineEdit {
                        text: root.rename-dialog-value;
                        placeholder-text: "Enter new name...";
                        accepted => {
                            root.confirm-rename(self.text);
                            root.show-rename-dialog = false;
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Rectangle { horizontal-stretch: 1; }
                        Button {
                            text: "Cancel";
                            clicked => { root.show-rename-dialog = false; }
                        }
                        Button {
                            text: "OK";
                            primary: true;
                            clicked => {
                                root.confirm-rename(rename-input.text);
                                root.show-rename-dialog = false;
                            }
                        }
                    }
                }
            }
        }

        // Global lock shield while launched process is running
        if root.locked : Rectangle {
            background: #000000.transparentize(88%);
            z: 1500;
            TouchArea { }

            Rectangle {
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                width: 420px;
                height: 120px;
                background: Palette.background;
                border-radius: 8px;
                border-width: 1px;
                border-color: Palette.border;

                VerticalLayout {
                    padding: 12px;
                    spacing: 8px;
                    Text {
                        text: "Application Locked";
                        font-size: 16px;
                        font-weight: 700;
                        horizontal-alignment: center;
                        color: #f44336;
                    }
                    Text {
                        text: "Running: " + root.locked-tool-name;
                        horizontal-alignment: center;
                        color: Palette.foreground;
                        overflow: elide;
                    }
                    HorizontalLayout {
                        Rectangle { horizontal-stretch: 1; }
                        Button { text: "Force Unlock"; clicked => { root.force-unlock(); } }
                        Rectangle { horizontal-stretch: 1; }
                    }
                }
            }
        }

        // ===== Install Mod Overlay Dialog =====
        if root.show-install-dialog : Rectangle {
            background: #000000.transparentize(50%);

            TouchArea { }

            Rectangle {
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                width: min(parent.width - 40px, 560px);
                height: min(parent.height - 60px, 520px);
                background: Palette.background;
                border-radius: 8px;
                border-width: 1px;
                border-color: Palette.border;
                drop-shadow-blur: 8px;
                drop-shadow-color: #000000.transparentize(70%);
                clip: true;

                VerticalLayout {
                    padding: 0;
                    spacing: 0;

                    // Title bar
                    Rectangle {
                        height: 40px;
                        background: Palette.alternate-background;

                        HorizontalLayout {
                            padding: 12px;
                            Text {
                                text: "Install Mod";
                                font-size: 16px;
                                font-weight: 700;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                        }
                    }

                    Rectangle { height: 1px; background: Palette.border; }

                    // Mod name field
                    HorizontalLayout {
                        padding: 12px;
                        spacing: 8px;
                        Text {
                            text: "Name:";
                            font-size: 12px;
                            vertical-alignment: center;
                            color: Palette.foreground;
                            width: 45px;
                        }
                        install-name-input := LineEdit {
                            text: root.install-mod-name;
                            horizontal-stretch: 1;
                        }
                    }

                    // Validation indicator
                    Rectangle {
                        height: 28px;
                        background: root.install-data-valid
                            ? #4CAF50.transparentize(85%)
                            : #f44336.transparentize(85%);

                        HorizontalLayout {
                            padding-left: 12px;
                            Text {
                                text: root.install-data-valid
                                    ? "Content looks valid (data directory detected)."
                                    : "Content may not be valid. Right-click a directory to set as data root.";
                                font-size: 11px;
                                vertical-alignment: center;
                                color: root.install-data-valid ? #4CAF50 : #f44336;
                            }
                        }
                    }

                    Rectangle { height: 1px; background: Palette.border; }

                    // Content tree
                    ScrollView {
                        vertical-stretch: 1;

                        VerticalLayout {
                            spacing: 0;
                            for tree-entry[idx] in root.install-tree : Rectangle {
                                height: 24px;
                                background: install-tree-touch.has-hover
                                    ? Palette.accent-background.transparentize(80%)
                                    : tree-entry.is-data-root
                                        ? (root.install-data-valid
                                            ? #4CAF50.transparentize(90%)
                                            : #f44336.transparentize(90%))
                                        : transparent;

                                install-tree-touch := TouchArea {
                                    mouse-cursor: tree-entry.is-directory ? pointer : default;
                                    clicked => {
                                        if (tree-entry.is-directory && tree-entry.has-children) {
                                            root.install-toggle-expand(tree-entry.path);
                                        }
                                    }
                                    pointer-event(event) => {
                                        if (event.kind == PointerEventKind.up && event.button == PointerEventButton.right) {
                                            root.install-tree-context-path = tree-entry.path;
                                            root.install-tree-context-is-dir = tree-entry.is-directory;
                                            root.install-tree-menu-x = self.absolute-position.x + self.mouse-x;
                                            root.install-tree-menu-y = self.absolute-position.y + self.mouse-y;
                                            root.show-install-tree-menu = true;
                                        }
                                    }
                                }

                                HorizontalLayout {
                                    padding-left: tree-entry.depth * 20px + 8px;
                                    spacing: 4px;

                                    // Expand/collapse arrow for directories
                                    if tree-entry.is-directory && tree-entry.has-children : Text {
                                        width: 14px;
                                        text: tree-entry.is-expanded ? "\u{25BC}" : "\u{25B6}";
                                        font-size: 9px;
                                        vertical-alignment: center;
                                        color: Palette.foreground.transparentize(40%);
                                    }
                                    if !(tree-entry.is-directory && tree-entry.has-children) : Rectangle {
                                        width: 14px;
                                    }

                                    // Folder/file icon
                                    Text {
                                        width: 16px;
                                        text: tree-entry.is-directory ? "\u{1F4C1}" : "\u{1F4C4}";
                                        font-size: 11px;
                                        vertical-alignment: center;
                                    }

                                    // Name
                                    Text {
                                        text: tree-entry.is-data-root
                                            ? tree-entry.name + " <data>"
                                            : tree-entry.name;
                                        font-size: 11px;
                                        vertical-alignment: center;
                                        color: tree-entry.is-data-root
                                            ? (root.install-data-valid ? #4CAF50 : #f44336)
                                            : Palette.foreground;
                                        font-weight: tree-entry.is-data-root ? 700 : 400;
                                        overflow: elide;
                                    }
                                }
                            }
                        }
                    }

                    Rectangle { height: 1px; background: Palette.border; }

                    // OK / Cancel buttons
                    HorizontalLayout {
                        padding: 12px;
                        spacing: 8px;
                        Rectangle { horizontal-stretch: 1; }
                        Button {
                            text: "Cancel";
                            clicked => {
                                root.show-install-tree-menu = false;
                                root.install-cancel();
                            }
                        }
                        Button {
                            text: "OK";
                            primary: true;
                            enabled: install-name-input.text != "";
                            clicked => {
                                root.show-install-tree-menu = false;
                                root.install-confirm(install-name-input.text);
                            }
                        }
                    }
                }
            }
        }

        if root.show-install-tree-menu : Rectangle {
            TouchArea {
                clicked => { root.show-install-tree-menu = false; }
            }

            Rectangle {
                x: root.install-tree-menu-x;
                y: root.install-tree-menu-y;
                width: 190px;
                height: root.install-tree-context-is-dir ? 57px : 28px;
                background: Palette.background;
                border-radius: 4px;
                border-width: 1px;
                border-color: Palette.border;
                clip: true;
                z: 2000;

                VerticalLayout {
                    spacing: 0px;
                    if root.install-tree-context-is-dir : Rectangle {
                        height: 28px;
                        background: install-ctx-data.has-hover ? Palette.accent-background.transparentize(70%) : transparent;
                        install-ctx-data := TouchArea {
                            mouse-cursor: pointer;
                            clicked => {
                                root.install-set-data-dir(root.install-tree-context-path);
                                root.show-install-tree-menu = false;
                            }
                        }
                        HorizontalLayout {
                            padding-left: 10px;
                            Text { text: "Set as Data Directory"; font-size: 11px; vertical-alignment: center; }
                        }
                    }
                    if root.install-tree-context-is-dir : Rectangle { height: 1px; background: Palette.border; }
                    Rectangle {
                        height: 28px;
                        background: install-ctx-folder.has-hover ? Palette.accent-background.transparentize(70%) : transparent;
                        install-ctx-folder := TouchArea {
                            mouse-cursor: pointer;
                            clicked => {
                                root.install-create-folder(root.install-tree-context-path);
                                root.show-install-tree-menu = false;
                            }
                        }
                        HorizontalLayout {
                            padding-left: 10px;
                            Text { text: "Create Folder Here"; font-size: 11px; vertical-alignment: center; }
                        }
                    }
                }
            }
        }

        // ===== Tool Editor Overlay Dialog =====
        if root.show-tool-editor : Rectangle {
            background: #000000.transparentize(50%);

            TouchArea { }

            Rectangle {
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                width: min(parent.width - 40px, 700px);
                height: min(parent.height - 60px, 500px);
                background: Palette.background;
                border-radius: 8px;
                border-width: 1px;
                border-color: Palette.border;
                clip: true;

                VerticalBox {
                    padding: 0;
                    spacing: 0;

                    // Title bar
                    Rectangle {
                        height: 40px;
                        background: Palette.alternate-background;

                        HorizontalBox {
                            padding: 12px;
                            Text {
                                text: "Modify Executables";
                                font-size: 16px;
                                font-weight: 700;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: Palette.border;
                    }

                    HorizontalBox {
                        vertical-stretch: 1;
                        spacing: 0;

                        // Left: executable list
                        VerticalBox {
                            width: 200px;

                            ListView {
                                vertical-stretch: 1;

                                for tool[index] in root.tool-list : Rectangle {
                                    height: 32px;
                                    background: index == root.selected-tool ? Palette.accent-background
                                        : mod(index, 2) == 0 ? Palette.alternate-background
                                        : Palette.background;

                                    TouchArea {
                                        clicked => { root.select-tool(index); }
                                    }

                                    HorizontalBox {
                                        padding-left: 12px;
                                        padding-right: 8px;

                                        Text {
                                            text: tool.title;
                                            vertical-alignment: center;
                                            overflow: elide;
                                            font-weight: index == root.selected-tool ? 600 : 400;
                                            color: Palette.foreground;
                                        }
                                    }
                                }
                            }

                            Rectangle {
                                height: 1px;
                                background: Palette.border;
                            }

                            HorizontalBox {
                                height: 36px;
                                padding: 4px;
                                spacing: 4px;

                                Button {
                                    text: "Add";
                                    clicked => { root.add-tool(); }
                                }
                                Button {
                                    text: "Remove";
                                    enabled: root.selected-tool >= 0;
                                    clicked => { root.remove-tool(root.selected-tool); }
                                }
                            }
                        }

                        Rectangle {
                            width: 1px;
                            background: Palette.border;
                        }

                        // Right: edit form
                        VerticalBox {
                            horizontal-stretch: 1;
                            padding: 12px;
                            spacing: 8px;

                            GridBox {
                                spacing: 8px;

                                Row {
                                    Text {
                                        text: "Title:";
                                        vertical-alignment: center;
                                        color: Palette.foreground;
                                        horizontal-alignment: right;
                                    }
                                    tool-title-input := LineEdit {
                                        text: root.tool-edit-title;
                                        edited(val) => { root.tool-edit-title = val; }
                                        placeholder-text: "Tool name";
                                    }
                                }
                                Row {
                                    Text {
                                        text: "Binary:";
                                        vertical-alignment: center;
                                        color: Palette.foreground;
                                        horizontal-alignment: right;
                                    }
                                    HorizontalBox {
                                        spacing: 4px;
                                        tool-binary-input := LineEdit {
                                            horizontal-stretch: 1;
                                            text: root.tool-edit-binary;
                                            edited(val) => { root.tool-edit-binary = val; }
                                            placeholder-text: "/path/to/executable";
                                        }
                                        Button {
                                            text: "...";
                                            width: 32px;
                                            clicked => { root.browse-tool-binary(); }
                                        }
                                    }
                                }
                                Row {
                                    Text {
                                        text: "Start In:";
                                        vertical-alignment: center;
                                        color: Palette.foreground;
                                        horizontal-alignment: right;
                                    }
                                    HorizontalBox {
                                        spacing: 4px;
                                        tool-workdir-input := LineEdit {
                                            horizontal-stretch: 1;
                                            text: root.tool-edit-workdir;
                                            edited(val) => { root.tool-edit-workdir = val; }
                                            placeholder-text: "/path/to/working/directory";
                                        }
                                        Button {
                                            text: "...";
                                            width: 32px;
                                            clicked => { root.browse-tool-workdir(); }
                                        }
                                    }
                                }
                                Row {
                                    Text {
                                        text: "Arguments:";
                                        vertical-alignment: center;
                                        color: Palette.foreground;
                                        horizontal-alignment: right;
                                    }
                                    tool-args-input := LineEdit {
                                        text: root.tool-edit-arguments;
                                        edited(val) => { root.tool-edit-arguments = val; }
                                        placeholder-text: "-arg1 -arg2";
                                    }
                                }
                            }

                            HorizontalBox {
                                spacing: 16px;
                                padding-left: 4px;

                                CheckBox {
                                    text: "Show in toolbar";
                                    checked: root.tool-edit-toolbar;
                                    toggled => { root.tool-edit-toolbar = self.checked; }
                                }
                                CheckBox {
                                    text: "Hide in UI";
                                    checked: root.tool-edit-hide;
                                    toggled => { root.tool-edit-hide = self.checked; }
                                }
                            }

                            Rectangle { vertical-stretch: 1; }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: Palette.border;
                    }

                    HorizontalBox {
                        height: 44px;
                        padding: 8px;
                        spacing: 8px;

                        Rectangle { horizontal-stretch: 1; }

                        Button {
                            text: "OK";
                            clicked => {
                                root.save-tools();
                                root.show-tool-editor = false;
                            }
                        }
                        Button {
                            text: "Cancel";
                            clicked => {
                                root.close-tool-editor();
                            }
                        }
                        Button {
                            text: "Apply";
                            clicked => {
                                root.save-tools();
                            }
                        }
                    }
                }
            }
        }

        // ===== Settings Overlay Dialog =====
        if root.show-settings : Rectangle {
            background: #000000.transparentize(50%);

            TouchArea { }

            Rectangle {
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                width: min(parent.width - 40px, 750px);
                height: min(parent.height - 60px, 560px);
                background: Palette.background;
                border-radius: 8px;
                border-width: 1px;
                border-color: Palette.border;
                clip: true;

                VerticalBox {
                    padding: 0;
                    spacing: 0;

                    // Title bar
                    Rectangle {
                        height: 40px;
                        background: Palette.alternate-background;

                        HorizontalBox {
                            padding: 12px;
                            Text {
                                text: "Settings";
                                font-size: 16px;
                                font-weight: 700;
                                vertical-alignment: center;
                                color: Palette.foreground;
                            }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: Palette.border;
                    }

                    // Tab bar
                    HorizontalBox {
                        height: 36px;
                        padding: 4px;
                        spacing: 2px;

                        for tab-item[tab-idx] in [
                            { text: "General" },
                            { text: "Mod List" },
                            { text: "Paths" },
                            { text: "Wine/Proton" },
                        ] : Rectangle {
                            horizontal-stretch: 0;
                            width: 90px;
                            height: 28px;
                            border-radius: 4px;
                            background: root.settings-tab == tab-idx ? Palette.accent-background : transparent;

                            TouchArea {
                                clicked => { root.settings-tab = tab-idx; }
                            }

                            VerticalLayout {
                                alignment: center;
                                HorizontalLayout {
                                    alignment: center;
                                    Text {
                                        text: tab-item.text;
                                        font-weight: root.settings-tab == tab-idx ? 700 : 400;
                                        color: Palette.foreground;
                                        font-size: 13px;
                                    }
                                }
                            }
                        }

                        Rectangle { horizontal-stretch: 1; }
                    }

                    Rectangle {
                        height: 1px;
                        background: Palette.border;
                    }

                    // Tab content
                    ScrollView {
                        vertical-stretch: 1;

                        // === General tab ===
                        if root.settings-tab == 0 : VerticalBox {
                            padding: 16px;
                            spacing: 6px;

                            Text {
                                text: "Download List";
                                font-weight: 700;
                                color: Palette.foreground;
                            }
                            CheckBox {
                                text: "Show meta information";
                                checked: true;
                            }
                            CheckBox {
                                text: "Compact list";
                                checked: true;
                            }
                            CheckBox {
                                text: "Hide downloads after installation";
                                checked: true;
                            }

                            Rectangle { height: 12px; }

                            Text {
                                text: "Profile Defaults";
                                font-weight: 700;
                                color: Palette.foreground;
                            }
                            CheckBox {
                                text: "Local INIs";
                                checked: root.settings-local-inis;
                                toggled => { root.set-profile-local-inis(self.checked); }
                            }
                            CheckBox {
                                text: "Local Saves";
                                checked: root.settings-local-saves;
                                toggled => { root.set-profile-local-saves(self.checked); }
                            }
                            CheckBox {
                                text: "Automatic Archive Invalidation";
                                checked: root.settings-auto-archive-invalidation;
                                toggled => { root.set-profile-auto-archive-invalidation(self.checked); }
                            }

                            Rectangle { height: 12px; }

                            Text {
                                text: "Miscellaneous";
                                font-weight: 700;
                                color: Palette.foreground;
                            }
                            CheckBox {
                                text: "Always center dialogs";
                                checked: true;
                            }
                            CheckBox {
                                text: "Show confirmation when changing instance";
                                checked: true;
                            }

                            Rectangle { vertical-stretch: 1; }
                        }

                        // === Mod List tab ===
                        if root.settings-tab == 1 : VerticalBox {
                            padding: 16px;
                            spacing: 6px;

                            CheckBox {
                                text: "Show mod list separator colors on the scrollbar";
                                checked: true;
                            }
                            CheckBox {
                                text: "Display mods installed outside MO";
                                checked: true;
                            }
                            CheckBox {
                                text: "Remember selected filters after restarting MO";
                                checked: false;
                            }
                            CheckBox {
                                text: "Check for updates when installing mods";
                                checked: true;
                            }
                            CheckBox {
                                text: "Automatically collapse items during drag on hover";
                                checked: false;
                            }

                            Rectangle { height: 12px; }

                            Text {
                                text: "Collapsible Separators";
                                font-weight: 700;
                                color: Palette.foreground;
                            }

                            HorizontalBox {
                                spacing: 24px;

                                Text {
                                    text: "Enable when sorting by";
                                    vertical-alignment: center;
                                    color: Palette.foreground;
                                }
                                CheckBox {
                                    text: "ascending priority";
                                    checked: true;
                                }
                                CheckBox {
                                    text: "descending priority";
                                    checked: true;
                                }
                            }

                            HorizontalBox {
                                spacing: 24px;

                                Text {
                                    text: "Show conflicts and plugins";
                                    vertical-alignment: center;
                                    color: Palette.foreground;
                                }
                                CheckBox {
                                    text: "on separators";
                                    checked: true;
                                }
                                CheckBox {
                                    text: "from separators";
                                    checked: true;
                                }
                            }

                            HorizontalBox {
                                spacing: 24px;

                                Text {
                                    text: "Show icons on separators";
                                    vertical-alignment: center;
                                    color: Palette.foreground;
                                }
                                CheckBox {
                                    text: "conflicts";
                                    checked: true;
                                }
                                CheckBox {
                                    text: "flags";
                                    checked: true;
                                }
                                CheckBox {
                                    text: "content";
                                    checked: true;
                                }
                                CheckBox {
                                    text: "version";
                                    checked: true;
                                }
                            }

                            CheckBox {
                                text: "Profile-specific collapse states for separators";
                                checked: false;
                            }

                            Rectangle { vertical-stretch: 1; }
                        }

                        // === Paths tab ===
                        if root.settings-tab == 2 : VerticalBox {
                            padding: 16px;
                            spacing: 8px;

                            GridBox {
                                spacing: 8px;

                                Row {
                                    Text {
                                        text: "Base Directory";
                                        vertical-alignment: center;
                                        color: Palette.foreground;
                                    }
                                    HorizontalBox {
                                        spacing: 4px;
                                        Rectangle {
                                            horizontal-stretch: 1;
                                            height: 28px;
                                            border-radius: 4px;
                                            border-width: 1px;
                                            border-color: Palette.border;
                                            background: Palette.alternate-background;
                                            clip: true;
                                            HorizontalBox {
                                                padding-left: 6px;
                                                padding-right: 6px;
                                                Text {
                                                    text: root.settings-base-dir;
                                                    vertical-alignment: center;
                                                    horizontal-alignment: right;
                                                    overflow: elide;
                                                    color: Palette.foreground;
                                                    font-size: 12px;
                                                }
                                            }
                                        }
                                        Button {
                                            text: "...";
                                            width: 32px;
                                            clicked => { root.browse-settings-base-dir(); }
                                        }
                                    }
                                }
                            }

                            Rectangle { height: 16px; }

                            GridBox {
                                spacing: 8px;

                                Row {
                                    Text {
                                        text: "Downloads";
                                        vertical-alignment: center;
                                        color: Palette.foreground;
                                    }
                                    HorizontalBox {
                                        spacing: 4px;
                                        Rectangle {
                                            horizontal-stretch: 1;
                                            height: 28px;
                                            border-radius: 4px;
                                            border-width: 1px;
                                            border-color: Palette.border;
                                            background: Palette.alternate-background;
                                            clip: true;
                                            HorizontalBox {
                                                padding-left: 6px;
                                                padding-right: 6px;
                                                Text {
                                                    text: root.settings-downloads-dir;
                                                    vertical-alignment: center;
                                                    horizontal-alignment: right;
                                                    overflow: elide;
                                                    color: Palette.foreground;
                                                    font-size: 12px;
                                                }
                                            }
                                        }
                                        Button {
                                            text: "...";
                                            width: 32px;
                                            clicked => { root.browse-settings-downloads(); }
                                        }
                                    }
                                }
                                Row {
                                    Text {
                                        text: "Mods";
                                        vertical-alignment: center;
                                        color: Palette.foreground;
                                    }
                                    HorizontalBox {
                                        spacing: 4px;
                                        Rectangle {
                                            horizontal-stretch: 1;
                                            height: 28px;
                                            border-radius: 4px;
                                            border-width: 1px;
                                            border-color: Palette.border;
                                            background: Palette.alternate-background;
                                            clip: true;
                                            HorizontalBox {
                                                padding-left: 6px;
                                                padding-right: 6px;
                                                Text {
                                                    text: root.settings-mods-dir;
                                                    vertical-alignment: center;
                                                    horizontal-alignment: right;
                                                    overflow: elide;
                                                    color: Palette.foreground;
                                                    font-size: 12px;
                                                }
                                            }
                                        }
                                        Button {
                                            text: "...";
                                            width: 32px;
                                            clicked => { root.browse-settings-mods(); }
                                        }
                                    }
                                }
                                Row {
                                    Text {
                                        text: "Profiles";
                                        vertical-alignment: center;
                                        color: Palette.foreground;
                                    }
                                    HorizontalBox {
                                        spacing: 4px;
                                        Rectangle {
                                            horizontal-stretch: 1;
                                            height: 28px;
                                            border-radius: 4px;
                                            border-width: 1px;
                                            border-color: Palette.border;
                                            background: Palette.alternate-background;
                                            clip: true;
                                            HorizontalBox {
                                                padding-left: 6px;
                                                padding-right: 6px;
                                                Text {
                                                    text: root.settings-profiles-dir;
                                                    vertical-alignment: center;
                                                    horizontal-alignment: right;
                                                    overflow: elide;
                                                    color: Palette.foreground;
                                                    font-size: 12px;
                                                }
                                            }
                                        }
                                        Button {
                                            text: "...";
                                            width: 32px;
                                            clicked => { root.browse-settings-profiles(); }
                                        }
                                    }
                                }
                                Row {
                                    Text {
                                        text: "Overwrite";
                                        vertical-alignment: center;
                                        color: Palette.foreground;
                                    }
                                    HorizontalBox {
                                        spacing: 4px;
                                        Rectangle {
                                            horizontal-stretch: 1;
                                            height: 28px;
                                            border-radius: 4px;
                                            border-width: 1px;
                                            border-color: Palette.border;
                                            background: Palette.alternate-background;
                                            clip: true;
                                            HorizontalBox {
                                                padding-left: 6px;
                                                padding-right: 6px;
                                                Text {
                                                    text: root.settings-overwrite-dir;
                                                    vertical-alignment: center;
                                                    horizontal-alignment: right;
                                                    overflow: elide;
                                                    color: Palette.foreground;
                                                    font-size: 12px;
                                                }
                                            }
                                        }
                                        Button {
                                            text: "...";
                                            width: 32px;
                                            clicked => { root.browse-settings-overwrite(); }
                                        }
                                    }
                                }
                            }

                            Text {
                                text: "Use %BASE_DIR% to refer to the Base Directory.";
                                font-size: 11px;
                                color: Palette.foreground.transparentize(40%);
                            }

                            Rectangle { height: 16px; }

                            GridBox {
                                spacing: 8px;

                                Row {
                                    Text {
                                        text: "Managed Game";
                                        vertical-alignment: center;
                                        color: Palette.foreground;
                                    }
                                    HorizontalBox {
                                        spacing: 4px;
                                        Rectangle {
                                            horizontal-stretch: 1;
                                            height: 28px;
                                            border-radius: 4px;
                                            border-width: 1px;
                                            border-color: Palette.border;
                                            background: Palette.alternate-background;
                                            clip: true;
                                            HorizontalBox {
                                                padding-left: 6px;
                                                padding-right: 6px;
                                                Text {
                                                    text: root.game-path;
                                                    vertical-alignment: center;
                                                    horizontal-alignment: right;
                                                    overflow: elide;
                                                    color: Palette.foreground;
                                                    font-size: 12px;
                                                }
                                            }
                                        }
                                        Button {
                                            text: "...";
                                            width: 32px;
                                            clicked => { root.browse-game-path(); }
                                        }
                                    }
                                }
                            }

                            Rectangle { vertical-stretch: 1; }

                            Text {
                                text: "All directories must be writable.";
                                font-size: 11px;
                                color: Palette.foreground.transparentize(50%);
                            }
                        }

                        // === Wine/Proton tab (Fluorine Manager) ===
                        if root.settings-tab == 3 : VerticalBox {
                            padding: 16px;
                            spacing: 10px;

                            Text {
                                text: "Fluorine Manager";
                                font-weight: 700;
                                font-size: 14px;
                                color: Palette.foreground;
                            }

                            Text {
                                text: "Manages a single shared Wine/Proton prefix for all instances. Games run inside this prefix via Steam's Proton compatibility layer.";
                                font-size: 11px;
                                color: Palette.foreground.transparentize(40%);
                                wrap: word-wrap;
                            }

                            Rectangle { height: 4px; }

                            // --- Prefix Status ---
                            Rectangle {
                                height: 60px;
                                border-radius: 6px;
                                border-width: 1px;
                                border-color: root.prefix-exists ? #4a9 : Palette.border;
                                background: root.prefix-exists ? #4a9.transparentize(90%) : Palette.alternate-background;

                                HorizontalBox {
                                    padding: 12px;
                                    spacing: 10px;

                                    VerticalLayout {
                                        alignment: center;
                                        horizontal-stretch: 1;

                                        Text {
                                            text: root.prefix-exists ? "Prefix Active" : "No Prefix";
                                            font-weight: 700;
                                            color: root.prefix-exists ? #4a9 : Palette.foreground.transparentize(30%);
                                        }

                                        Text {
                                            text: root.prefix-status-text;
                                            font-size: 11px;
                                            color: Palette.foreground.transparentize(40%);
                                            overflow: elide;
                                        }
                                    }
                                }
                            }

                            Rectangle { height: 4px; }

                            // --- Proton Version Selector ---
                            Text {
                                text: "Proton Version";
                                font-weight: 700;
                                color: Palette.foreground;
                            }

                            ComboBox {
                                model: root.proton-names;
                                current-value: root.selected-proton-name;
                                selected(value) => {
                                    root.selected-proton-name = value;
                                    root.set-proton-version(value);
                                }
                            }

                            Rectangle { height: 8px; }

                            // --- Progress Bar (shown while busy) ---
                            if root.prefix-busy : VerticalLayout {
                                spacing: 4px;

                                Rectangle {
                                    height: 6px;
                                    border-radius: 3px;
                                    background: Palette.alternate-background;
                                    clip: true;

                                    Rectangle {
                                        x: 0;
                                        width: parent.width * root.prefix-progress;
                                        height: 100%;
                                        border-radius: 3px;
                                        background: #4a9;
                                    }
                                }
                            }

                            // --- Action Buttons ---
                            if !root.prefix-busy : HorizontalBox {
                                spacing: 8px;

                                if !root.prefix-exists : Button {
                                    text: "Create Prefix";
                                    clicked => { root.create-prefix(); }
                                }

                                if root.prefix-exists : Button {
                                    text: "Delete Prefix";
                                    clicked => { root.delete-prefix(); }
                                }
                            }

                            Text {
                                text: root.prefix-busy
                                    ? root.prefix-status-text
                                    : root.prefix-exists
                                        ? "Deleting the prefix removes it from disk. You can recreate it at any time."
                                        : "Select a Proton version above, then create the prefix. This adds a non-Steam game shortcut in Steam.";
                                font-size: 11px;
                                color: root.prefix-busy ? Palette.foreground : Palette.foreground.transparentize(40%);
                                wrap: word-wrap;
                            }

                            Rectangle { vertical-stretch: 1; }
                        }
                    }

                    Rectangle {
                        height: 1px;
                        background: Palette.border;
                    }

                    // Bottom button bar
                    HorizontalBox {
                        height: 44px;
                        padding: 8px;
                        spacing: 8px;

                        Rectangle { horizontal-stretch: 1; }

                        Button {
                            text: "OK";
                            clicked => {
                                root.show-settings = false;
                            }
                        }
                        Button {
                            text: "Cancel";
                            clicked => {
                                root.close-settings();
                            }
                        }
                    }
                }
            }
        }
    }
}
